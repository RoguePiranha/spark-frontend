<!DOCTYPE html>

<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta http-equiv="X-UA-Compatible" content="ie=edge" />
	<meta name="description" content="SPARK - Sales Performance and Revenue Keeper" />
	<meta name="author" content="SparkPro" />

	<title>SPARK - Deals and Customers</title>

	<script src="/assets/js/color-modes.js"></script>

	<link rel="preconnect" href="https://fonts.googleapis.com" />
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
	<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap"
		rel="stylesheet" />

	<link rel="stylesheet" href="/assets/vendors/core/core.css" />
	<link rel="stylesheet" href="/assets/vendors/datatables.net-bs5/dataTables.bootstrap5.css" />

	<link rel="stylesheet" href="/assets/fonts/feather-font/css/iconfont.css" />
	<link rel="stylesheet" href="/assets/css/style.css" />

	<link rel="shortcut icon" href="/assets/images/icons/white favicon.png" />
</head>

<style>
	/* Table niceties */
	#dealsTable tbody tr {
		cursor: pointer;
	}

	#dealsTable td,
	#dealsTable th {
		white-space: nowrap;
	}

	/* Content-sized modal (no backdrop), pinned over the page-content area */
	.modal.content-modal .modal-dialog {
		position: fixed;
		margin: 0;
		left: 0;
		top: 0;
		width: 100vw;
		height: 100vh;
		max-width: none;
		pointer-events: auto;
	}

	.modal.content-modal .modal-content {
		height: 100%;
		border-radius: 0;
	}

	.modal.content-modal .modal-body {
		overflow: auto;
	}
</style>

<style>
	body.mega-open #dealMegaModal.modal {
		z-index: 1000;
	}

	/* < navbar(1030), popover(1070) */
	body.mega-open .dropdown-menu,
	body.mega-open .popover,
	body.mega-open .tooltip,
	body.mega-open .offcanvas,
	body.mega-open .toast {
		z-index: 2000;
	}

	/* The full-screen modal container shouldn't intercept clicks */
	#dealMegaModal.modal {
		pointer-events: none;
		background: transparent;
	}

	#dealMegaModal .modal-dialog,
	#dealMegaModal .modal-content {
		pointer-events: auto;
	}

	/* (you already had these, keep them) */
	#dealMegaModal.content-modal .modal-dialog {
		position: fixed;
		margin: 0;
		left: 0;
		top: 0;
		width: 100vw;
		height: 100vh;
		max-width: none;
	}

	#dealMegaModal .modal-content {
		height: 100%;
		border-radius: 0;
	}

	#dealMegaModal .modal-body {
		overflow: auto;
	}
</style>

<body class="sidebar-dark">

	<div class="main-wrapper">
		<!-- partial:partials/_sidebar.html -->
		<nav class="sidebar">
			<div class="sidebar-header">
				<a href="#" class="sidebar-brand" aria-label="Spark Home" title="Spark Home">
					<img src="/assets/images/icons/horz-dark-mode-logo.png" class="sidebar-logo" alt="Spark Logo">
				</a>
				<div class="sidebar-toggler">
					<span></span>
					<span></span>
					<span></span>
				</div>
			</div>
			<div class="sidebar-body">
				<ul class="nav" id="sidebarNav">
					<li class="nav-item nav-category">Main</li>
					<li class="nav-item">
						<a href="/pages/dashboard.html" class="nav-link">
							<i class="link-icon" data-feather="zap"></i>
							<span class="link-title">Dashboard</span>
						</a>
					</li>
					<li class="nav-item nav-category">Web Apps</li>
					<li class="nav-item">
						<a href="/pages/apps/chat.html" class="nav-link">
							<i class="link-icon" data-feather="message-square"></i>
							<span class="link-title">Chat</span>
						</a>
					</li>
					<li class="nav-item">
						<a href="/pages/apps/calendar.html" class="nav-link">
							<i class="link-icon" data-feather="calendar"></i>
							<span class="link-title">Calendar</span>
						</a>
					</li>
					<li class="nav-item nav-category">Components</li>
					<li class="nav-item">
						<a href="/pages/profile.html" class="nav-link">
							<i class="link-icon" data-feather="user"></i>
							<span class="link-title">Profile</span>
						</a>
					</li>
					<li class="nav-item">
						<a href="/pages/my-team.html" class="nav-link">
							<i class="link-icon" data-feather="users"></i>
							<span class="link-title">My Team</span>
						</a>
					</li>
					<li class="nav-item">
						<a href="/pages/compensation.html" class="nav-link">
							<i class="link-icon" data-feather="dollar-sign"></i>
							<span class="link-title">Compensation</span>
						</a>
					</li>
					<li class="nav-item">
						<a href="/pages/installers.html" class="nav-link">
							<i class="link-icon" data-feather="tool"></i>
							<span class="link-title">Installers</span>
						</a>
					</li>
					<li class="nav-item">
						<a href="/pages/documents.html" class="nav-link">
							<i class="link-icon" data-feather="folder"></i>
							<span class="link-title">Documents</span>
						</a>
					</li>
					<li class="nav-item nav-category">Pages</li>
					<li class="nav-item">
						<a class="nav-link" data-bs-toggle="collapse" href="#general-pages" role="button"
							aria-expanded="false" aria-controls="general-pages">
							<i class="link-icon" data-feather="book"></i>
							<span class="link-title">Special pages</span>
							<i class="link-arrow" data-feather="chevron-down"></i>
						</a>
						<div class="collapse" data-bs-parent="#sidebarNav" id="general-pages">
							<ul class="nav sub-menu">
								<li class="nav-item">
									<a href="/pages/blank-page.html" class="nav-link">Blank page</a>
								</li>
								<li class="nav-item">
									<a href="/pages/faq.html" class="nav-link">Faq</a>
								</li>
								<li class="nav-item">
									<a href="/pages/invoice.html" class="nav-link">Invoice</a>
								</li>
								<li class="nav-item">
									<a href="/pages/profile.html" class="nav-link">Profile</a>
								</li>
								<li class="nav-item">
									<a href="/pages/pricing.html" class="nav-link">Pricing</a>
								</li>
								<li class="nav-item">
									<a href="/pages/timeline.html" class="nav-link">Timeline</a>
								</li>
							</ul>
						</div>
					</li>
					<li class="nav-item">
						<a class="nav-link" data-bs-toggle="collapse" href="#authPages" role="button"
							aria-expanded="false" aria-controls="authPages">
							<i class="link-icon" data-feather="unlock"></i>
							<span class="link-title">Authentication</span>
							<i class="link-arrow" data-feather="chevron-down"></i>
						</a>
						<div class="collapse" data-bs-parent="#sidebarNav" id="authPages">
							<ul class="nav sub-menu">
								<li class="nav-item">
									<a href="/pages/auth/login.html" class="nav-link">Login</a>
								</li>
								<li class="nav-item">
									<a href="/pages/auth/register.html" class="nav-link">Register</a>
								</li>
							</ul>
						</div>
					</li>
					<li class="nav-item nav-category">Docs</li>
					<li class="nav-item">
						<a href="/pages/settings.html" class="nav-link">
							<i class="link-icon" data-feather="settings"></i>
							<span class="link-title">Settings</span>
						</a>
					</li>
				</ul>
			</div>
		</nav>

		<!-- partial -->

		<div class="page-wrapper">
			<!-- partial:partials/_navbar.html -->
			<nav class="navbar">
				<div class="navbar-content">
					<div class="navbar-page-title d-flex align-items-center">
						<h2 class="mb-0 fw-bold" id="navbar-page-title"></h2>
					</div>

					<ul class="navbar-nav">
						<li class="theme-switcher-wrapper nav-item">
							<input type="checkbox" value="" id="theme-switcher" title="Toggle theme" />
							<label for="theme-switcher" aria-label="Toggle theme">
								<div class="box">
									<div class="ball"></div>
									<div class="icons">
										<i class="feather icon-sun"></i>
										<i class="feather icon-moon"></i>
									</div>
								</div>
							</label>
						</li>
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle" href="#" id="appsDropdown" role="button"
								data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="Apps">
								<i data-feather="grid"></i>
							</a>
							<div class="dropdown-menu p-0" aria-labelledby="appsDropdown">
								<div class="px-3 py-2 d-flex align-items-center justify-content-between border-bottom">
									<p class="mb-0 fw-bold">Web Apps</p>
									<a href="javascript:;" class="text-secondary">Edit</a>
								</div>
								<div class="row g-0 p-1">
									<div class="col-3 text-center">
										<a href="/pages/apps/chat.html"
											class="dropdown-item d-flex flex-column align-items-center justify-content-center w-70px h-70px"><i
												data-feather="message-square" class="icon-lg mb-1"></i>
											<p class="fs-12px">Chat</p>
										</a>
									</div>
									<div class="col-3 text-center">
										<a href="/pages/apps/calendar.html"
											class="dropdown-item d-flex flex-column align-items-center justify-content-center w-70px h-70px"><i
												data-feather="calendar" class="icon-lg mb-1"></i>
											<p class="fs-12px">Calendar</p>
										</a>
									</div>
									<div class="col-3 text-center">
										<a href="/pages/email/inbox.html"
											class="dropdown-item d-flex flex-column align-items-center justify-content-center w-70px h-70px"><i
												data-feather="mail" class="icon-lg mb-1"></i>
											<p class="fs-12px">Email</p>
										</a>
									</div>
									<div class="col-3 text-center">
										<a href="/pages/profile.html"
											class="dropdown-item d-flex flex-column align-items-center justify-content-center w-70px h-70px"><i
												data-feather="instagram" class="icon-lg mb-1"></i>
											<p class="fs-12px">Profile</p>
										</a>
									</div>
								</div>
								<div class="px-3 py-2 d-flex align-items-center justify-content-center border-top">
									<a href="javascript:;">View all</a>
								</div>
							</div>
						</li>
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle" href="#" id="messageDropdown" role="button"
								data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="Messages">
								<i data-feather="message-square"></i>
							</a>
							<div class="dropdown-menu p-0" aria-labelledby="messageDropdown">
								<div class="px-3 py-2 d-flex align-items-center justify-content-between border-bottom">
									<p>9 New Messages</p>
									<a href="javascript:;" class="text-secondary">Clear all</a>
								</div>
								<div class="p-1">
									<a href="javascript:;" class="dropdown-item d-flex align-items-center py-2">
										<div class="me-3">
											<img class="w-30px h-30px rounded-circle"
												src="/assets/images/profile_images/user_stock.png" alt="user" />
										</div>
										<div class="d-flex justify-content-between flex-grow-1">
											<div class="me-4">
												<p>Leonardo Payne</p>
												<p class="fs-12px text-secondary">Project status</p>
											</div>
											<p class="fs-12px text-secondary">2 min ago</p>
										</div>
									</a>
									<a href="javascript:;" class="dropdown-item d-flex align-items-center py-2">
										<div class="me-3">
											<img class="w-30px h-30px rounded-circle"
												src="/assets/images/profile_images/user_stock.png" alt="user" />
										</div>
										<div class="d-flex justify-content-between flex-grow-1">
											<div class="me-4">
												<p>Carl Henson</p>
												<p class="fs-12px text-secondary">Client meeting</p>
											</div>
											<p class="fs-12px text-secondary">30 min ago</p>
										</div>
									</a>
									<a href="javascript:;" class="dropdown-item d-flex align-items-center py-2">
										<div class="me-3">
											<img class="w-30px h-30px rounded-circle"
												src="/assets/images/profile_images/user_stock.png" alt="user" />
										</div>
										<div class="d-flex justify-content-between flex-grow-1">
											<div class="me-4">
												<p>Jensen Combs</p>
												<p class="fs-12px text-secondary">Project updates</p>
											</div>
											<p class="fs-12px text-secondary">1 hrs ago</p>
										</div>
									</a>
									<a href="javascript:;" class="dropdown-item d-flex align-items-center py-2">
										<div class="me-3">
											<img class="w-30px h-30px rounded-circle"
												src="/assets/images/profile_images/user_stock.png" alt="user" />
										</div>
										<div class="d-flex justify-content-between flex-grow-1">
											<div class="me-4">
												<p>Amiah Burton</p>
												<p class="fs-12px text-secondary">Project deatline</p>
											</div>
											<p class="fs-12px text-secondary">2 hrs ago</p>
										</div>
									</a>
									<a href="javascript:;" class="dropdown-item d-flex align-items-center py-2">
										<div class="me-3">
											<img class="w-30px h-30px rounded-circle"
												src="/assets/images/profile_images/user_stock.png" alt="user" />
										</div>
										<div class="d-flex justify-content-between flex-grow-1">
											<div class="me-4">
												<p>Yaretzi Mayo</p>
												<p class="fs-12px text-secondary">New record</p>
											</div>
											<p class="fs-12px text-secondary">5 hrs ago</p>
										</div>
									</a>
								</div>
								<div class="px-3 py-2 d-flex align-items-center justify-content-center border-top">
									<a href="javascript:;">View all</a>
								</div>
							</div>
						</li>
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle" href="#" id="notificationDropdown" role="button"
								data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
								title="Notifications">
								<i data-feather="bell"></i>
								<div class="indicator">
									<div class="circle"></div>
								</div>
							</a>
							<div class="dropdown-menu p-0" aria-labelledby="notificationDropdown">
								<div class="px-3 py-2 d-flex align-items-center justify-content-between border-bottom">
									<p>6 New Notifications</p>
									<a href="javascript:;" class="text-secondary">Clear all</a>
								</div>
								<div class="p-1">
									<a href="javascript:;" class="dropdown-item d-flex align-items-center py-2">
										<div
											class="w-30px h-30px d-flex align-items-center justify-content-center bg-primary rounded-circle me-3">
											<i class="icon-sm text-white" data-feather="gift"></i>
										</div>
										<div class="flex-grow-1 me-2">
											<p>New Order Recieved</p>
											<p class="fs-12px text-secondary">30 min ago</p>
										</div>
									</a>
									<a href="javascript:;" class="dropdown-item d-flex align-items-center py-2">
										<div
											class="w-30px h-30px d-flex align-items-center justify-content-center bg-primary rounded-circle me-3">
											<i class="icon-sm text-white" data-feather="alert-circle"></i>
										</div>
										<div class="flex-grow-1 me-2">
											<p>Server Limit Reached!</p>
											<p class="fs-12px text-secondary">1 hrs ago</p>
										</div>
									</a>
									<a href="javascript:;" class="dropdown-item d-flex align-items-center py-2">
										<div
											class="w-30px h-30px d-flex align-items-center justify-content-center bg-primary rounded-circle me-3">
											<img class="w-30px h-30px rounded-circle"
												src="/assets/images/profile_images/user_stock.png" alt="userr" />
										</div>
										<div class="flex-grow-1 me-2">
											<p>New customer registered</p>
											<p class="fs-12px text-secondary">2 sec ago</p>
										</div>
									</a>
									<a href="javascript:;" class="dropdown-item d-flex align-items-center py-2">
										<div
											class="w-30px h-30px d-flex align-items-center justify-content-center bg-primary rounded-circle me-3">
											<i class="icon-sm text-white" data-feather="layers"></i>
										</div>
										<div class="flex-grow-1 me-2">
											<p>Apps are ready for update</p>
											<p class="fs-12px text-secondary">5 hrs ago</p>
										</div>
									</a>
									<a href="javascript:;" class="dropdown-item d-flex align-items-center py-2">
										<div
											class="w-30px h-30px d-flex align-items-center justify-content-center bg-primary rounded-circle me-3">
											<i class="icon-sm text-white" data-feather="download"></i>
										</div>
										<div class="flex-grow-1 me-2">
											<p>Download completed</p>
											<p class="fs-12px text-secondary">6 hrs ago</p>
										</div>
									</a>
								</div>
								<div class="px-3 py-2 d-flex align-items-center justify-content-center border-top">
									<a href="javascript:;">View all</a>
								</div>
							</div>
						</li>
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button"
								data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								<img class="w-30px h-30px ms-1 rounded-circle"
									src="/assets/images/profile_images/user_stock.png" alt="profile" />
							</a>
							<div class="dropdown-menu p-0" aria-labelledby="profileDropdown">
								<div class="d-flex flex-column align-items-center border-bottom px-5 py-3">
									<div class="mb-3">
										<img class="w-80px h-80px rounded-circle"
											src="/assets/images/profile_images/user_stock.png" alt="" />
									</div>
									<div class="text-center">
										<p class="fs-16px fw-bolder" id="navbar-user-name">
											Loading...
										</p>
										<p class="fs-12px text-secondary" id="navbar-user-email">
											Loading...
										</p>
									</div>
								</div>
								<ul class="list-unstyled p-1">
									<li class="dropdown-item py-2">
										<a href="/pages/profile.html" class="text-body ms-0">
											<i class="me-2 icon-md" data-feather="user"></i>
											<span>Profile</span>
										</a>
									</li>
									<li class="dropdown-item py-2">
										<a href="javascript:;" class="text-body ms-0">
											<i class="me-2 icon-md" data-feather="edit"></i>
											<span>Edit Profile</span>
										</a>
									</li>
									<li class="dropdown-item py-2">
										<a href="javascript:;" class="text-body ms-0" onclick="logout()">
											<i class="me-2 icon-md" data-feather="log-out"></i>
											<span>Log Out</span>
										</a>
									</li>
								</ul>
							</div>
						</li>
					</ul>

					<a href="#" class="sidebar-toggler" title="Toggle Sidebar">
						<i data-feather="menu"></i>
					</a>
				</div>
				<script>
					document.addEventListener("DOMContentLoaded", async () => {
						const user = JSON.parse(localStorage.getItem("user"));
						if (!user) {
							window.location.href = "/pages/login.html";
							return;
						}

						try {
							const res = await fetch(`http://localhost:5001/profile/${user.userId}`);
							const data = await res.json();

							document.getElementById("navbar-user-name").textContent = `${data.firstName} ${data.lastName}`;
							document.getElementById("navbar-user-email").textContent = data.email ?? "-";
						} catch (err) {
							console.error("Failed to load profile data:", err);
						}
					});
				</script>

				<script>
					function logout() {
						localStorage.removeItem("user");
						window.location.href = "/pages/login.html";
					}
				</script>
				<script>
					// Set the page title in the navbar
					// Removes "SPARK - " from the title
					document.addEventListener("DOMContentLoaded", function () {
						let pageTitle = document.title || "Page";
						pageTitle = pageTitle.replace(/^\s*SPARK\s*-\s*/i, "");
						// this can override the title if you want it custom
						// let customTitle = document.body.getAttribute("data-page-title");
						document.getElementById("navbar-page-title").textContent = pageTitle;
					});
				</script>
			</nav>

			<!-- partial -->
			<div class="page-content">

				<!-- Filters -->
				<div class="row mb-4">
					<div class="col-12">
						<div class="card">
							<div class="card-body">
								<div class="row g-2 align-items-end">
									<div class="col-md-3 m-2">
										<label class="form-label">Search</label>
										<input id="dealSearch" class="form-control" placeholder="Customer or Deal ID…">
									</div>
									<div class="col-md-3 m-2">
										<label class="form-label">Project Type</label>
										<select id="filterProjectType" class="form-select">
											<option value="">All</option>
											<option>Solar</option>
											<option>Roofing</option>
											<option>Pest</option>
											<option>Fiber</option>
										</select>
									</div>
								</div>
								<div class="row g-2 align-items-end">
									<div class="col-md-3 m-2">
										<label class="form-label">From</label>
										<input type="date" id="dateFrom" class="form-control">
									</div>
									<div class="col-md-3 m-2">
										<label class="form-label">To</label>
										<input type="date" id="dateTo" class="form-control">
									</div>
								</div>
								<div class="row g-2 align-items-end">
									<div class="col-md-3 d-flex gap-2">
										<button class="btn btn-outline-secondary m-2" id="btnResetFilters"
											type="button">Reset</button>
										<button class="btn btn-primary m-2" id="btnApplyFilters"
											type="button">Apply</button>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Deals Table (6 columns only) -->
				<div class="row">
					<div class="col-12">
						<div class="card">
							<div class="card-body p-0">
								<div class="table-responsive">
									<table class="table table-hover align-middle mb-0" id="dealsTable">
										<thead class="table-light">
											<tr>
												<th>Deal ID</th>
												<th>Customer</th>
												<th>Type</th>
												<th>Already Paid</th>
												<th>Pending Amount</th>
												<th>Sign Date</th>
											</tr>
										</thead>
										<tbody><!-- renderDeals() --></tbody>
									</table>
								</div>
							</div>
						</div>
						<div class="small text-muted mt-2">Tip: Click a row to open the full Deal modal (Overview •
							Financials &
							Commissions • Docs).</div>
					</div>
				</div>
				<div class="modal fade content-modal" id="dealMegaModal" data-bs-backdrop="false" tabindex="-1"
					aria-hidden="true">
					<div class="modal-dialog modal-dialog-scrollable" id="dealMegaDialog">
						<div class="modal-content">
							<div class="modal-header">
								<h6 class="modal-title" id="mm-title">Deal</h6>
								<button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
							</div>

							<div class="modal-body p-0">
								<ul class="nav nav-tabs px-3 pt-3" id="mmTabs" role="tablist">
									<li class="nav-item" role="presentation">
										<button class="nav-link active" id="mm-overview-tab" data-bs-toggle="tab"
											data-bs-target="#mm-overview" type="button" role="tab">Overview</button>
									</li>
									<li class="nav-item" role="presentation">
										<button class="nav-link" id="mm-fin-tab" data-bs-toggle="tab"
											data-bs-target="#mm-fin" type="button" role="tab">Financials &
											Commissions</button>
									</li>
									<li class="nav-item" role="presentation">
										<button class="nav-link" id="mm-docs-tab" data-bs-toggle="tab"
											data-bs-target="#mm-docs" type="button" role="tab">Docs</button>
									</li>
								</ul>

								<div class="tab-content p-3" id="mmTabContent">
									<!-- Overview -->
									<div class="tab-pane fade show active" id="mm-overview" role="tabpanel">
										<div class="row g-3">
											<div class="col-12">
												<img id="mm-google-street" alt="Street View"
													style="width: 100%; max-height: 240px; object-fit: cover; border-radius: .5rem; border: 1px solid rgba(0,0,0,.1);" />
											</div>

											<div class="col-12">
												<div class="card">
													<div class="card-body">
														<h6 class="fw-bold mb-3">Core Deal Information</h6>
														<div class="row g-3">
															<div class="col-md-3">
																<div class="small text-muted">Deal ID</div>
																<div id="mm-deal-id">-</div>
															</div>
															<div class="col-md-3">
																<div class="small text-muted">Customer Name</div>
																<div id="mm-customer-name">-</div>
															</div>
															<div class="col-md-3">
																<div class="small text-muted">Product Type</div>
																<div id="mm-product-type">-</div>
															</div>
															<div class="col-md-3">
																<div class="small text-muted">Project Status</div>
																<div id="mm-project-status">-</div>
															</div>
															<div class="col-md-3">
																<div class="small text-muted">Project Stage</div>
																<div id="mm-project-stage">-</div>
															</div>
															<div class="col-md-3">
																<div class="small text-muted">Signed Contract</div>
																<div id="mm-contract-date">-</div>
															</div>
															<div class="col-md-3">
																<div class="small text-muted">Created</div>
																<div id="mm-created-date">-</div>
															</div>
															<div class="col-md-3">
																<div class="small text-muted">Payout</div>
																<div id="mm-payout">-</div>
															</div>
														</div>
														<div class="my-3">
															<label class="form-label fw-bold">Status Progress</label>
															<div class="progress">
																<div class="progress-bar" id="mm-status-progress"
																	style="width: 25%">
																	Submitted</div>
															</div>
														</div>
													</div>
												</div>
											</div>

											<div class="col-12 col-lg-6">
												<div class="card">
													<div class="card-body">
														<h6 class="fw-bold mb-3">👤 Customer Details</h6>
														<div class="row g-2">
															<div class="col-md-6">
																<div class="small text-muted">Full Name</div>
																<div id="mm-customer-name-2">-</div>
															</div>
															<div class="col-md-6">
																<div class="small text-muted">Phone</div>
																<div id="mm-customer-phone">-</div>
															</div>
															<div class="col-md-6">
																<div class="small text-muted">Email</div>
																<div id="mm-customer-email">-</div>
															</div>
															<div class="col-12">
																<div class="small text-muted">Address</div>
																<div id="mm-customer-address">-</div>
															</div>
															<div class="col-12">
																<div class="ratio ratio-16x9"><iframe id="mm-google-map"
																		src="" allowfullscreen loading="lazy"></iframe>
																</div>
															</div>
															<div class="col-md-6">
																<div class="small text-muted">Lead Source</div>
																<div id="mm-lead-source">-</div>
															</div>
														</div>
													</div>
												</div>
											</div>

											<div class="col-12 col-lg-6">
												<div class="card">
													<div class="card-body">
														<h6 class="fw-bold mb-3">👥 Sales Team</h6>
														<div class="row g-2">
															<div class="col-md-6">
																<div class="small text-muted">Sales Rep</div>
																<div id="mm-sales-rep">-</div>
															</div>
															<div class="col-md-6">
																<div class="small text-muted">Setter(s)</div>
																<div id="mm-setters">-</div>
															</div>
															<div class="col-md-6">
																<div class="small text-muted">Closer(s)</div>
																<div id="mm-closers">-</div>
															</div>
															<div class="col-md-6">
																<div class="small text-muted">Team / Office</div>
																<div id="mm-team-office">-</div>
															</div>
															<div class="col-md-6">
																<div class="small text-muted">Dealer/Partner</div>
																<div id="mm-dealer">-</div>
															</div>
														</div>
													</div>
												</div>

												<div class="card mt-3">
													<div class="card-body">
														<h6 class="fw-bold mb-3">🗕️ Tracking & Reporting</h6>
														<div class="row g-2">
															<div class="col-md-6">
																<div class="small text-muted">Initial Lead Date
																</div>
																<div id="mm-lead-date">-</div>
															</div>
															<div class="col-md-6">
																<div class="small text-muted">Close Date</div>
																<div id="mm-close-date">-</div>
															</div>
															<div class="col-md-6">
																<div class="small text-muted">Install Date</div>
																<div id="mm-install-date">-</div>
															</div>
															<div class="col-md-6">
																<div class="small text-muted">Rep Paid Date</div>
																<div id="mm-paid-date">-</div>
															</div>
															<div class="col-12">
																<div class="small text-muted">Tags / Deal Flags
																</div>
																<div id="mm-tags">-</div>
															</div>
															<div class="col-12"><a href="#" id="mm-dispute-link"
																	target="_blank">Quick Dispute Link</a></div>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>

									<!-- Financials & Commissions -->
									<div class="tab-pane fade" id="mm-fin" role="tabpanel">
										<div id="mm-fin-summary" class="row g-3 mb-3"></div>
										<div id="mm-fin-body"></div>
										<div id="mm-payments"></div>
									</div>

									<!-- Docs -->
									<div class="tab-pane fade" id="mm-docs" role="tabpanel">
										<div class="card">
											<div class="card-body">
												<div class="table-responsive">
													<table class="table table-hover">
														<thead>
															<tr>
																<th>Document</th>
																<th>View</th>
																<th>Download</th>
															</tr>
														</thead>
														<tbody id="mm-docs-body"><!-- render --></tbody>
													</table>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>

						</div>
					</div>
				</div>
			</div>
			<!-- /page-content -->
			<!-- partial:partials/_footer.html -->
			<footer
				class="footer d-flex flex-row align-items-center justify-content-between px-4 py-3 border-top small">
				<p class="text-secondary mb-1 mb-md-0">Copyright © <span id="currentYear"></span>
					<a href="https://sparkpro.io" target="_blank" rel="noopener noreferrer">Spark</a>.
				</p>
				<script>document.getElementById("currentYear").textContent = new Date().getFullYear();</script>
				<p class="text-secondary">Handcrafted By<i class="mb-1 text-primary ms-1 icon-sm"
						data-feather="zap"></i>
				</p>
			</footer>

			<!-- partial -->
		</div>
	</div>

	<!-- core:js -->
	<script src="/assets/vendors/core/core.js"></script>
	<!-- endinject -->

	<!-- Plugin js for this page -->

	<script src="/assets/vendors/datatables.net/dataTables.js"></script>
	<!-- End plugin js for this page -->

	<!-- inject:js -->
	<script src="/assets/vendors/feather-icons/feather.min.js"></script>
	<script src="/assets/js/app.js"></script>
	<!-- endinject -->


	<script>
		(function () {
			/* =========================
			   DUMMY DATA (replace later)
			   ========================= */
			const deals = [
				{
					id: 22001, customer: 'Jane Doe', projectType: 'Solar', signDate: '2025-08-15',
					mp1: 1800, mp2: 1200, mp3: 0, overrides: [{ name: 'Q3 Bonus', amount: 150 }], setterDeduction: 200, repSplitPct: 60,
					payments: [{ date: '2025-09-12', amount: 1000 }],
					solar: {
						systemSizeKw: 7.2, panelBrand: 'REC', inverter: 'SolarEdge', batteryKwh: 10,
						dealer: 'SunBest', installer: 'BrightInstall', redline: '$2.25/W',
						finance: { lender: 'GoodLeap', program: 'GL-25', apr: 6.99, termMonths: 300 },
						milestones: { submitted: '2025-08-17', install: '2025-09-10', pto: '2025-09-18' },
						adders: [{ name: 'Main Panel Upgrade', amount: 800 }]
					}
				},
				{
					id: 22002, customer: 'ACME HQ', projectType: 'Fiber', signDate: '2025-08-20',
					mp1: 600, mp2: 0, mp3: 0, overrides: [], setterDeduction: 0, repSplitPct: 70,
					payments: [{ date: '2025-09-02', amount: 300 }],
					fiber: {
						serviceAddress: '123 Industrial Way, Austin, TX', provider: 'GigaNet', speedTier: '2 Gbps Symmetric',
						contractTermMonths: 36, installDate: '2025-09-05', mrc: 899, otc: 299, circuitId: 'GN-TX-99123'
					}
				},
				{
					id: 22003, customer: 'Smith Family', projectType: 'Roofing', signDate: '2025-08-10',
					mp1: 1500, mp2: 500, mp3: 0, overrides: [{ name: 'Manager Override', amount: 250 }], setterDeduction: 0, repSplitPct: 65,
					payments: [],
					roofing: {
						squares: 28, material: 'Architectural Asphalt', pitch: '6/12', layers: 1,
						insurance: { rcv: 19500, acv: 17200, deductible: 1500 },
						installDate: '2025-09-12', permits: 'City of Round Rock'
					}
				},
				{
					id: 22004, customer: 'John Smith', projectType: 'Pest', signDate: '2025-08-22',
					mp1: 350, mp2: 150, mp3: 50, overrides: [], setterDeduction: 50, repSplitPct: 50,
					payments: [{ date: '2025-09-05', amount: 200 }],
					pest: { plan: 'Quarterly', termMonths: 12, initialFee: 99, recurring: 49, startDate: '2025-08-25', serviceAddress: '44 Maple St' }
				},
				{
					id: 22005, customer: 'Blue Papaya Café', projectType: 'Solar', signDate: '2025-07-30',
					mp1: 2200, mp2: 1200, mp3: 800, overrides: [{ name: 'Commercial Bonus', amount: 500 }], setterDeduction: 0, repSplitPct: 55,
					payments: [{ date: '2025-08-20', amount: 1500 }, { date: '2025-09-15', amount: 700 }],
					solar: {
						systemSizeKw: 45.6, panelBrand: 'QCells', inverter: 'Enphase', batteryKwh: 0,
						dealer: 'SunPro', installer: 'VoltNation', redline: '$1.95/W',
						finance: { lender: 'Sunlight', program: 'SL-20', apr: 7.49, termMonths: 240 },
						milestones: { submitted: '2025-08-02', install: '2025-09-05', pto: null },
						adders: []
					}
				},
				{
					id: 22006, customer: 'Miller Residence', projectType: 'Roofing', signDate: '2025-09-01',
					mp1: 900, mp2: 0, mp3: 0, overrides: [], setterDeduction: 150, repSplitPct: 60,
					payments: [{ date: '2025-09-10', amount: 300 }],
					roofing: { squares: 19, material: 'Metal', pitch: '4/12', layers: 1, installDate: null, permits: 'County Permit #7731' }
				},
				{
					id: 22007, customer: 'Northside Storage', projectType: 'Fiber', signDate: '2025-08-01',
					mp1: 800, mp2: 200, mp3: 0, overrides: [], setterDeduction: 0, repSplitPct: 60,
					payments: [{ date: '2025-08-25', amount: 400 }],
					fiber: {
						serviceAddress: '88 Logistics Rd, Dallas, TX', provider: 'MetroFiber', speedTier: '1 Gbps',
						contractTermMonths: 24, installDate: '2025-09-03', mrc: 699, otc: 199, circuitId: 'MF-DAL-44110'
					}
				},
				{
					id: 22008, customer: 'Johnson Home', projectType: 'Pest', signDate: '2025-09-05',
					mp1: 300, mp2: 0, mp3: 0, overrides: [{ name: 'Back-to-School Promo', amount: 25 }], setterDeduction: 0, repSplitPct: 50,
					payments: [],
					pest: { plan: 'Bi-Monthly', termMonths: 12, initialFee: 79, recurring: 39, startDate: '2025-09-06', serviceAddress: '12 Pine Ln' }
				}
			];

			const overviewById = {
				22001: {
					customerName: 'Jane Doe', address: '742 Evergreen Ter, Springfield', email: 'jane.doe@example.com', phone: '(555) 111-2222',
					projectStatus: 'In Progress', projectStage: 'Installed', createdDate: '2025-07-20', payout: '$12,300',
					statusProgress: '60%', customerName2: 'Jane A. Doe', leadSource: 'Online', salesRep: 'Alex Ray',
					setters: 'Mike Johnson', closers: 'Alex Ray', teamOffice: 'Mesa', dealer: 'SunBest',
					leadDate: '2025-07-10', closeDate: '2025-08-15', installDate: '2025-09-10', paidDate: '2025-09-12',
					tags: 'Battery, HOA', disputeLink: '#'
				},
				22002: {
					customerName: 'ACME HQ', address: '123 Industrial Way, Austin, TX', email: 'it@acme.com', phone: '(512) 555-4455',
					projectStatus: 'Active', projectStage: 'Live', createdDate: '2025-07-28', payout: '$1,200',
					statusProgress: '100%', customerName2: 'ACME Headquarters', leadSource: 'Partner', salesRep: 'Taylor V.',
					setters: '—', closers: 'Taylor V.', teamOffice: 'Austin', dealer: 'GigaNet',
					leadDate: '2025-07-20', closeDate: '2025-08-20', installDate: '2025-09-05', paidDate: '2025-09-10',
					tags: 'Fiber, B2B', disputeLink: '#'
				},
				22003: {
					customerName: 'Smith Family', address: '9 Elm St, Round Rock, TX', email: 'smiths@example.com', phone: '(737) 555-1020',
					projectStatus: 'Scheduled', projectStage: 'Install Scheduled', createdDate: '2025-07-18', payout: '$2,100',
					statusProgress: '40%', customerName2: 'Bob & Karen Smith', leadSource: 'Door', salesRep: 'Morgan Lee',
					setters: 'Team 3', closers: 'Morgan Lee', teamOffice: 'Round Rock', dealer: 'A1 Roofing',
					leadDate: '2025-07-01', closeDate: '2025-08-10', installDate: '2025-09-12', paidDate: '',
					tags: 'Insurance Claim', disputeLink: '#'
				},
				22004: {
					customerName: 'John Smith', address: '44 Maple St', email: 'john.smith@example.com', phone: '(480) 555-9090',
					projectStatus: 'Active', projectStage: 'Service Started', createdDate: '2025-08-18', payout: '$550',
					statusProgress: '50%', customerName2: 'John H. Smith', leadSource: 'Referral', salesRep: 'Ava Chen',
					setters: '—', closers: 'Ava Chen', teamOffice: 'Phoenix', dealer: 'BugAway',
					leadDate: '2025-08-10', closeDate: '2025-08-22', installDate: '2025-08-25', paidDate: '2025-09-05',
					tags: 'AutoPay', disputeLink: '#'
				}
			};

			const docsById = {
				22001: [{ name: 'Contract.pdf', url: '/testFiles/contract.pdf' }, { name: 'Site Plan.png', url: '/testFiles/site-plan.png' }],
				22002: [{ name: 'LOA.pdf', url: '/testFiles/loa.pdf' }, { name: 'Circuit Diagram.pdf', url: '/testFiles/circuit.pdf' }],
				22003: [{ name: 'Insurance Scope.pdf', url: '/testFiles/scope.pdf' }],
				22004: [{ name: 'Service Agreement.pdf', url: '/testFiles/pest-agreement.pdf' }]
			};

			/* =========================
			   RENDER TABLE + MEGA MODAL
			   ========================= */
			const $ = s => document.querySelector(s);
			const $$ = s => Array.from(document.querySelectorAll(s));

			// Modal elements
			const megaEl = document.getElementById('dealMegaModal');
			const dlg = document.getElementById('dealMegaDialog');

			// Utils
			const toNum = x => (x == null ? 0 : Number(String(x).replace(/[^0-9.-]/g, '')) || 0);
			const sum = (arr, fn = x => x) => (arr || []).reduce((a, b) => a + fn(b), 0);
			const fmtMoney = n => (toNum(n)).toLocaleString(undefined, { style: 'currency', currency: 'USD', maximumFractionDigits: 2 });
			const fmtDate = d => d ? new Date(d + 'T00:00:00').toLocaleDateString() : '';
			const escapeHtml = s => (s ?? '').toString().replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
			const overridesTotal = ov => sum(ov || [], o => toNum(o.amount));
			function calcRepDue(d) { const pool = toNum(d.mp1) + toNum(d.mp2) + toNum(d.mp3) + overridesTotal(d.overrides) - toNum(d.setterDeduction); return Math.max(0, pool * (toNum(d.repSplitPct) / 100)); }
			const calcPaid = d => sum(d.payments || [], p => toNum(p.amount));
			const calcPending = d => Math.max(0, calcRepDue(d) - calcPaid(d));

			// Position the dialog to cover only .page-content
			function positionMegaModal() {
				const page = document.querySelector('.page-content');
				if (!page) return;
				const r = page.getBoundingClientRect();
				Object.assign(dlg.style, {
					left: r.left + 'px',
					top: r.top + 'px',
					width: r.width + 'px',
					height: r.height + 'px'
				});
			}

			// Build summary/payment/type sections
			function summaryRow(d) {
				const paid = calcPaid(d), pending = calcPending(d);
				return `
	      <div class="col-sm-6 col-lg-3"><div class="card"><div class="card-body">
	        <div class="small text-muted">Already Paid</div><div class="h5 mb-0">${fmtMoney(paid)}</div>
	      </div></div></div>
	      <div class="col-sm-6 col-lg-3"><div class="card"><div class="card-body">
	        <div class="small text-muted">Pending Amount</div><div class="h5 mb-0">${fmtMoney(pending)}</div>
	      </div></div></div>
	      <div class="col-sm-6 col-lg-3"><div class="card"><div class="card-body">
	        <div class="small text-muted">Sign Date</div><div class="h5 mb-0">${fmtDate(d.signDate)}</div>
	      </div></div></div>
	      <div class="col-sm-6 col-lg-3"><div class="card"><div class="card-body">
	        <div class="small text-muted">Rep Split</div><div class="h5 mb-0">${toNum(d.repSplitPct)}%</div>
	      </div></div></div>`;
			}
			function renderCommissionMini(d) {
				return `
	      <div class="card mb-3"><div class="card-body">
	        <div class="fw-semibold mb-2">Commission Breakdown</div>
	        <div class="row g-3">
	          <div class="col-md-2"><div class="small text-muted">MP1</div><div>${fmtMoney(d.mp1)}</div></div>
	          ${toNum(d.mp2) ? `<div class="col-md-2"><div class="small text-muted">MP2</div><div>${fmtMoney(d.mp2)}</div></div>` : ''}
	          ${toNum(d.mp3) ? `<div class="col-md-2"><div class="small text-muted">MP3</div><div>${fmtMoney(d.mp3)}</div></div>` : ''}
	          <div class="col-md-3"><div class="small text-muted">Overrides</div><div>${fmtMoney(overridesTotal(d.overrides))}</div></div>
	          <div class="col-md-3"><div class="small text-muted">Setter Deduction</div><div>- ${fmtMoney(d.setterDeduction || 0)}</div></div>
	        </div>
	      </div></div>`;
			}
			function renderPayments(d) {
				const items = (d.payments || []).map(p => `
	      <li class="list-group-item d-flex justify-content-between">
	        <span>${fmtDate(p.date)}</span><span>${fmtMoney(p.amount)}</span>
	      </li>`).join('');
				return `
	      <div class="card"><div class="card-body">
	        <div class="fw-semibold mb-2">Payments</div>
	        ${(d.payments && d.payments.length) ? `<ul class="list-group list-group-flush">${items}</ul>` : `<div class="text-muted">No payments recorded.</div>`}
	      </div></div>`;
			}

			function finSolar(d) {
				const s = d.solar || {}; const adders = (s.adders || []).map(a => `<li class="list-group-item d-flex justify-content-between"><span>${escapeHtml(a.name)}</span><span>${fmtMoney(a.amount)}</span></li>`).join('');
				return `
	      <div class="card mb-3"><div class="card-body">
	        <div class="fw-semibold mb-2">System</div>
	        <div class="row g-3">
	          <div class="col-md-3"><div class="small text-muted">Size</div><div>${s.systemSizeKw ?? '-'} kW</div></div>
	          <div class="col-md-3"><div class="small text-muted">Panel</div><div>${escapeHtml(s.panelBrand || '-')}</div></div>
	          <div class="col-md-3"><div class="small text-muted">Inverter</div><div>${escapeHtml(s.inverter || '-')}</div></div>
	          <div class="col-md-3"><div class="small text-muted">Battery</div><div>${s.batteryKwh ? s.batteryKwh + ' kWh' : '-'}</div></div>
	          <div class="col-md-3"><div class="small text-muted">Dealer</div><div>${escapeHtml(s.dealer || '-')}</div></div>
	          <div class="col-md-3"><div class="small text-muted">Installer</div><div>${escapeHtml(s.installer || '-')}</div></div>
	          <div class="col-md-3"><div class="small text-muted">Redline</div><div>${escapeHtml(s.redline || '-')}</div></div>
	        </div>
	      </div></div>
	      <div class="card mb-3"><div class="card-body">
	        <div class="fw-semibold mb-2">Finance</div>
	        <div class="row g-3">
	          <div class="col-md-3"><div class="small text-muted">Lender</div><div>${escapeHtml(s.finance?.lender || '-')}</div></div>
	          <div class="col-md-3"><div class="small text-muted">Program</div><div>${escapeHtml(s.finance?.program || '-')}</div></div>
	          <div class="col-md-3"><div class="small text-muted">APR</div><div>${s.finance?.apr ?? '-'}%</div></div>
	          <div class="col-md-3"><div class="small text-muted">Term</div><div>${s.finance?.termMonths ?? '-'} mo</div></div>
	        </div>
	      </div></div>
	      <div class="card mb-3"><div class="card-body">
	        <div class="fw-semibold mb-2">Milestones</div>
	        <div class="row g-3">
	          <div class="col-md-4"><div class="small text-muted">Submitted</div><div>${fmtDate(s.milestones?.submitted)}</div></div>
	          <div class="col-md-4"><div class="small text-muted">Install</div><div>${fmtDate(s.milestones?.install)}</div></div>
	          <div class="col-md-4"><div class="small text-muted">PTO</div><div>${fmtDate(s.milestones?.pto)}</div></div>
	        </div>
	      </div></div>
	      ${(s.adders && s.adders.length) ? `<div class="card mb-3"><div class="card-body"><div class="fw-semibold mb-2">Adders</div><ul class="list-group list-group-flush">${adders}</ul></div></div>` : ''}
	      ${renderCommissionMini(d)}`;
			}
			function finFiber(d) {
				const f = d.fiber || {};
				return `
	      <div class="card mb-3"><div class="card-body">
	        <div class="fw-semibold mb-2">Circuit</div>
	        <div class="row g-3">
	          <div class="col-md-6"><div class="small text-muted">Service Address</div><div>${escapeHtml(f.serviceAddress || '-')}</div></div>
	          <div class="col-md-3"><div class="small text-muted">Provider</div><div>${escapeHtml(f.provider || '-')}</div></div>
	          <div class="col-md-3"><div class="small text-muted">Speed Tier</div><div>${escapeHtml(f.speedTier || '-')}</div></div>
	          <div class="col-md-3"><div class="small text-muted">Term</div><div>${f.contractTermMonths ?? '-'} mo</div></div>
	          <div class="col-md-3"><div class="small text-muted">MRC</div><div>${fmtMoney(f.mrc)}</div></div>
	          <div class="col-md-3"><div class="small text-muted">OTC</div><div>${fmtMoney(f.otc)}</div></div>
	          <div class="col-md-3"><div class="small text-muted">Circuit ID</div><div>${escapeHtml(f.circuitId || '-')}</div></div>
	          <div class="col-md-3"><div class="small text-muted">Install Date</div><div>${fmtDate(f.installDate)}</div></div>
	        </div>
	      </div></div>
	      ${renderCommissionMini(d)}`;
			}
			function finRoofing(d) {
				const r = d.roofing || {};
				return `
	      <div class="card mb-3"><div class="card-body">
	        <div class="fw-semibold mb-2">Project</div>
	        <div class="row g-3">
	          <div class="col-md-3"><div class="small text-muted">Squares</div><div>${r.squares ?? '-'}</div></div>
	          <div class="col-md-3"><div class="small text-muted">Material</div><div>${escapeHtml(r.material || '-')}</div></div>
	          <div class="col-md-3"><div class="small text-muted">Pitch</div><div>${escapeHtml(r.pitch || '-')}</div></div>
	          <div class="col-md-3"><div class="small text-muted">Layers</div><div>${r.layers ?? '-'}</div></div>
	          <div class="col-md-3"><div class="small text-muted">Install Date</div><div>${fmtDate(r.installDate)}</div></div>
	          <div class="col-md-3"><div class="small text-muted">Permits</div><div>${escapeHtml(r.permits || '-')}</div></div>
	        </div>
	      </div></div>
	      ${r.insurance ? `
	      <div class="card mb-3"><div class="card-body">
	        <div class="fw-semibold mb-2">Insurance</div>
	        <div class="row g-3">
	          <div class="col-md-4"><div class="small text-muted">RCV</div><div>${fmtMoney(r.insurance.rcv)}</div></div>
	          <div class="col-md-4"><div class="small text-muted">ACV</div><div>${fmtMoney(r.insurance.acv)}</div></div>
	          <div class="col-md-4"><div class="small text-muted">Deductible</div><div>${fmtMoney(r.insurance.deductible)}</div></div>
	        </div>
	      </div></div>`: ''}
	      ${renderCommissionMini(d)}`;
			}
			function finPest(d) {
				const p = d.pest || {};
				return `
	      <div class="card mb-3"><div class="card-body">
	        <div class="fw-semibold mb-2">Subscription</div>
	        <div class="row g-3">
	          <div class="col-md-3"><div class="small text-muted">Plan</div><div>${escapeHtml(p.plan || '-')}</div></div>
	          <div class="col-md-3"><div class="small text-muted">Term</div><div>${p.termMonths ?? '-'} mo</div></div>
	          <div class="col-md-3"><div class="small text-muted">Initial Fee</div><div>${fmtMoney(p.initialFee)}</div></div>
	          <div class="col-md-3"><div class="small text-muted">Recurring</div><div>${fmtMoney(p.recurring)}</div></div>
	          <div class="col-md-6"><div class="small text-muted">Service Address</div><div>${escapeHtml(p.serviceAddress || '-')}</div></div>
	          <div class="col-md-3"><div class="small text-muted">Start</div><div>${fmtDate(p.startDate)}</div></div>
	        </div>
	      </div></div>
	      ${renderCommissionMini(d)}`;
			}
			function renderType(d) {
				switch ((d.projectType || '').toLowerCase()) {
					case 'solar': return finSolar(d);
					case 'fiber': return finFiber(d);
					case 'roofing': return finRoofing(d);
					case 'pest': return finPest(d);
					default: return `<div class="text-muted">No template for type "${escapeHtml(d.projectType)}".</div>`;
				}
			}

			function renderDocsFor(id) {
				const items = (docsById[id] || []).map(doc => `
	      <tr>
	        <td>${escapeHtml(doc.name)}</td>
	        <td><a href="${doc.url}" target="_blank" title="View"><i data-feather="eye"></i></a></td>
	        <td><a href="${doc.url}" download title="Download"><i data-feather="download"></i></a></td>
	      </tr>`).join('');
				$('#mm-docs-body').innerHTML = items || `<tr><td colspan="3" class="text-muted">No documents uploaded.</td></tr>`;
				if (window.feather && feather.replace) feather.replace();
			}

			// Create the modal ONCE with interaction-friendly options
			let mega = bootstrap.Modal.getInstance(megaEl);
			if (mega) mega.dispose();
			mega = new bootstrap.Modal(megaEl, { backdrop: false, focus: false, keyboard: true });

			// Let outside area remain interactive (defeat focus trap reclaim)
			const allowOutsideFocus = (e) => {
				if (!megaEl.classList.contains('show')) return;
				if (!e.target.closest('#dealMegaModal')) e.stopPropagation();
			};

			megaEl.addEventListener('shown.bs.modal', () => {
				document.body.classList.add('mega-open');          // <-- add
				document.body.classList.remove('modal-open');
				document.body.style.removeProperty('padding-right');
				document.addEventListener('focusin', allowOutsideFocus, true);
				positionMegaModal();
			});

			megaEl.addEventListener('hidden.bs.modal', () => {
				document.body.classList.remove('mega-open');       // <-- add
				document.removeEventListener('focusin', allowOutsideFocus, true);
			});


			// Keep dialog aligned to page-content
			window.addEventListener('resize', positionMegaModal, { passive: true });
			window.addEventListener('scroll', positionMegaModal, { passive: true });
			document.querySelectorAll('.sidebar-toggler').forEach(btn => {
				btn.addEventListener('click', () => setTimeout(positionMegaModal, 250));
			});

			// Filters
			const state = { rows: deals.slice(), filtered: deals.slice() };
			function applyFilters() {
				const q = ($('#dealSearch').value || '').trim().toLowerCase();
				const proj = $('#filterProjectType').value;
				const from = $('#dateFrom').value ? new Date($('#dateFrom').value + 'T00:00:00') : null;
				const to = $('#dateTo').value ? new Date($('#dateTo').value + 'T23:59:59') : null;

				state.filtered = state.rows.filter(d => {
					if (q && !(String(d.id).includes(q) || (d.customer || '').toLowerCase().includes(q))) return false;
					if (proj && d.projectType !== proj) return false;

					const pend = calcPending(d);

					if (from || to) {
						const sd = d.signDate ? new Date(d.signDate + 'T00:00:00') : null;
						if (from && (!sd || sd < from)) return false;
						if (to && (!sd || sd > to)) return false;
					}
					return true;
				});
				renderDeals();
			}
			function resetFilters() {
				$('#dealSearch').value = ''; $('#filterProjectType').value = '';
				$('#dateFrom').value = ''; $('#dateTo').value = '';
				applyFilters();
			}
			$('#btnApplyFilters').addEventListener('click', applyFilters);
			$('#btnResetFilters').addEventListener('click', resetFilters);
			$('#dealSearch').addEventListener('input', applyFilters);
			$('#filterProjectType').addEventListener('change', applyFilters);
			$('#dateFrom').addEventListener('change', applyFilters);
			$('#dateTo').addEventListener('change', applyFilters);

			// Table rendering + click → open modal
			function renderDeals() {
				const tbody = $('#dealsTable tbody');
				tbody.innerHTML = state.filtered.map(d => `
	      <tr data-id="${d.id}">
	        <td>${d.id}</td>
	        <td>${escapeHtml(d.customer)}</td>
	        <td>${escapeHtml(d.projectType)}</td>
	        <td>${fmtMoney(calcPaid(d))}</td>
	        <td><strong>${fmtMoney(calcPending(d))}</strong></td>
	        <td>${fmtDate(d.signDate)}</td>
	      </tr>`).join('') || `<tr><td colspan="6" class="text-center text-muted">No deals match your filters.</td></tr>`;
			}
			$('#dealsTable').addEventListener('click', (e) => {
				const tr = e.target.closest('tr[data-id]'); if (!tr) return;
				const id = Number(tr.dataset.id);
				const d = state.rows.find(x => x.id === id); if (!d) return;
				const ov = overviewById[id];
				openMegaModal(d, ov);
			});

			// Open & fill mega modal
			function renderDocsForAndIcons(id) {
				renderDocsFor(id);
				if (window.feather && feather.replace) feather.replace();
			}
			function openMegaModal(d, ov) {
				document.getElementById('mm-title').textContent = `${d.projectType || 'Deal'} • ${d.customer || '-'} • #${d.id || '-'}`;

				const o = ov || {};
				const address = o.address || d?.fiber?.serviceAddress || d?.pest?.serviceAddress || '';
				const mapUrl = address ? `https://www.google.com/maps?q=${encodeURIComponent(address)}&layer=c&output=svembed` : '';
				const streetUrl = address ? `https://maps.googleapis.com/maps/api/streetview?size=1200x480&location=${encodeURIComponent(address)}&pitch=-0.76` : '';

				$('#mm-deal-id').textContent = d.id ?? '-';
				$('#mm-customer-name').textContent = d.customer ?? o.customerName ?? '-';
				$('#mm-product-type').textContent = d.projectType ?? '-';
				$('#mm-project-status').textContent = o.projectStatus ?? '-';
				$('#mm-project-stage').textContent = o.projectStage ?? '-';
				$('#mm-contract-date').textContent = d.signDate ? fmtDate(d.signDate) : (o.signDate || '-');
				$('#mm-created-date').textContent = o.createdDate ?? '-';
				$('#mm-payout').textContent = o.payout ?? '-';

				const pb = document.getElementById('mm-status-progress');
				pb.style.width = o.statusProgress || '25%';
				pb.textContent = o.statusProgress || '25%';

				$('#mm-customer-name-2').textContent = o.customerName2 || d.customer || '-';
				$('#mm-customer-phone').textContent = o.phone || '-';
				$('#mm-customer-email').textContent = o.email || '-';
				$('#mm-customer-address').textContent = address || '-';
				$('#mm-google-map').src = mapUrl;
				$('#mm-google-street').src = streetUrl;
				$('#mm-lead-source').textContent = o.leadSource || '-';
				$('#mm-sales-rep').textContent = o.salesRep || '-';
				$('#mm-setters').textContent = o.setters || '-';
				$('#mm-closers').textContent = o.closers || '-';
				$('#mm-team-office').textContent = o.teamOffice || '-';
				$('#mm-dealer').textContent = o.dealer || '-';
				$('#mm-lead-date').textContent = o.leadDate || '-';
				$('#mm-close-date').textContent = o.closeDate || '-';
				$('#mm-install-date').textContent = o.installDate || '-';
				$('#mm-paid-date').textContent = o.paidDate || '-';
				$('#mm-tags').textContent = o.tags || '-';
				$('#mm-dispute-link').href = o.disputeLink || '#';

				// Financials
				$('#mm-fin-summary').innerHTML = summaryRow(d);
				$('#mm-fin-body').innerHTML = renderType(d);
				$('#mm-payments').innerHTML = renderPayments(d);

				// Docs
				renderDocsForAndIcons(d.id);

				if (window.feather && feather.replace) feather.replace();
				mega.show();
			}

			// Init
			renderDeals();
			positionMegaModal();
		})();
	</script>


	<!-- Custom js for this page -->
	<script src="/assets/js/data-table.js"></script>
	<!-- End custom js for this page -->
</body>

</html>
<!DOCTYPE html>