<!DOCTYPE html>



<!-- PERMISSIONS -->
<!-- OFFICE STAFF ONLY -->

<html lang="en">
	<link
		rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/orgchart@3.7.0/dist/css/jquery.orgchart.min.css" />
	<link
		href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
		rel="stylesheet" />
	<style>
		#chart-viewport {
			position: relative;
			height: 70vh;
			/* pick your height */
			overflow: hidden;
			touch-action: none;
			/* critical for mobile pan + pinch */
			border-radius: 0.5rem;
		}

		#chart-stage {
			position: absolute;
			top: 0;
			left: 0;
			transform-origin: 0 0;
			/* important for math below */
			cursor: grab;
		}

		#chart-stage.dragging {
			cursor: grabbing;
		}

		/* lay out multiple trees side-by-side inside the stage */
		.orgchart-wrapper {
			display: inline-block;
			vertical-align: top;
			margin: 0 24px;
		}

		/* Remove orgchart grid background */
		.orgchart {
			background: transparent !important;
			/* no grid, no color */
		}

		.orgchart .node .title {
			background-color: #007bff;
			color: #fff;
		}

		.orgchart .node .content {
			border-color: #007bff;
		}
	</style>

	<style>
		/* Let the drawer scroll and wrap long values */
		#memberDrawer .offcanvas-body {
			overflow-y: auto;
		}

		#memberDrawer .info-grid .value {
			word-break: break-word;
		}

		#memberDrawer .info-grid .card-field {
			min-width: 0;
		}
	</style>

	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0" />
		<meta
			http-equiv="X-UA-Compatible"
			content="ie=edge" />
		<meta
			name="description"
			content="SPARK - Sales Performance and Revenue Keeper" />
		<meta
			name="author"
			content="SparkPro" />

		<title>Spark - My Team</title>

		<!-- color-modes:js -->
		<script src="/assets/js/color-modes.js"></script>
		<!-- endinject -->

		<!-- Fonts -->
		<link
			rel="preconnect"
			href="https://fonts.googleapis.com" />
		<link
			rel="preconnect"
			href="https://fonts.gstatic.com"
			crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap"
			rel="stylesheet" />
		<!-- End fonts -->

		<!-- core:css -->
		<link
			rel="stylesheet"
			href="/assets/vendors/core/core.css" />
		<!-- endinject -->

		<!-- Plugin css for this page -->
		<!-- End plugin css for this page -->

		<!-- inject:css -->
		<link
			rel="stylesheet"
			href="/assets/fonts/feather-font/css/iconfont.css" />
		<!-- endinject -->

		<!-- Layout styles -->
		<link
			rel="stylesheet"
			href="/assets/css/style.css" />
		<!-- End layout styles -->

		<link
			rel="shortcut icon"
			href="/icons/white favicon.png" />
	</head>

	<body class="sidebar-dark">
		<div class="main-wrapper">
			<!-- partial:partials/_sidebar.html -->
			<nav class="sidebar">
				<div class="sidebar-header">
					<a
						href="#"
						class="sidebar-brand"
						aria-label="Spark Home"
						title="Spark Home">
						<img
							src="/pages/icons/horz-dark-mode-logo.png"
							class="sidebar-logo"
							alt="Spark Logo" />
					</a>
					<div class="sidebar-toggler">
						<span></span>
						<span></span>
						<span></span>
					</div>
				</div>
				<div class="sidebar-body">
					<ul
						class="nav"
						id="sidebarNav">
						<li class="nav-item nav-category">Main</li>
						<li class="nav-item">
							<a
								href="/pages/dashboard.html"
								class="nav-link">
								<i
									class="link-icon"
									data-feather="zap"></i>
								<span class="link-title">Dashboard</span>
							</a>
						</li>
						<li class="nav-item nav-category">Web Apps</li>
						<li class="nav-item">
							<a
								href="/pages/apps/chat.html"
								class="nav-link">
								<i
									class="link-icon"
									data-feather="message-square"></i>
								<span class="link-title">Chat</span>
							</a>
						</li>
						<li class="nav-item">
							<a
								href="/pages/apps/calendar.html"
								class="nav-link">
								<i
									class="link-icon"
									data-feather="calendar"></i>
								<span class="link-title">Calendar</span>
							</a>
						</li>
						<li class="nav-item nav-category">Components</li>
						<li class="nav-item">
							<a
								href="/pages/profile.html"
								class="nav-link">
								<i
									class="link-icon"
									data-feather="user"></i>
								<span class="link-title">Profile</span>
							</a>
						</li>
						<li class="nav-item">
							<a
								href="/pages/my-team.html"
								class="nav-link">
								<i
									class="link-icon"
									data-feather="users"></i>
								<span class="link-title">My Team</span>
							</a>
						</li>
						<li class="nav-item">
							<a
								href="/pages/compensation.html"
								class="nav-link">
								<i
									class="link-icon"
									data-feather="dollar-sign"></i>
								<span class="link-title">Compensation</span>
							</a>
						</li>
						<li class="nav-item">
							<a
								href="/pages/installers.html"
								class="nav-link">
								<i
									class="link-icon"
									data-feather="tool"></i>
								<span class="link-title">Installers</span>
							</a>
						</li>
						<li class="nav-item">
							<a
								href="/pages/documents.html"
								class="nav-link">
								<i
									class="link-icon"
									data-feather="folder"></i>
								<span class="link-title">Documents</span>
							</a>
						</li>
						<li class="nav-item nav-category">Pages</li>
						<li class="nav-item">
							<a
								class="nav-link"
								data-bs-toggle="collapse"
								href="#general-pages"
								role="button"
								aria-expanded="false"
								aria-controls="general-pages">
								<i
									class="link-icon"
									data-feather="book"></i>
								<span class="link-title">Special pages</span>
								<i
									class="link-arrow"
									data-feather="chevron-down"></i>
							</a>
							<div
								class="collapse"
								data-bs-parent="#sidebarNav"
								id="general-pages">
								<ul class="nav sub-menu">
									<li class="nav-item">
										<a
											href="/pages/blank-page.html"
											class="nav-link"
											>Blank page</a
										>
									</li>
									<li class="nav-item">
										<a
											href="/pages/faq.html"
											class="nav-link"
											>Faq</a
										>
									</li>
									<li class="nav-item">
										<a
											href="/pages/invoice.html"
											class="nav-link"
											>Invoice</a
										>
									</li>
									<li class="nav-item">
										<a
											href="/pages/profile.html"
											class="nav-link"
											>Profile</a
										>
									</li>
									<li class="nav-item">
										<a
											href="/pages/pricing.html"
											class="nav-link"
											>Pricing</a
										>
									</li>
									<li class="nav-item">
										<a
											href="/pages/timeline.html"
											class="nav-link"
											>Timeline</a
										>
									</li>
								</ul>
							</div>
						</li>
						<li class="nav-item">
							<a
								class="nav-link"
								data-bs-toggle="collapse"
								href="#authPages"
								role="button"
								aria-expanded="false"
								aria-controls="authPages">
								<i
									class="link-icon"
									data-feather="unlock"></i>
								<span class="link-title">Authentication</span>
								<i
									class="link-arrow"
									data-feather="chevron-down"></i>
							</a>
							<div
								class="collapse"
								data-bs-parent="#sidebarNav"
								id="authPages">
								<ul class="nav sub-menu">
									<li class="nav-item">
										<a
											href="/pages/auth/login.html"
											class="nav-link"
											>Login</a
										>
									</li>
									<li class="nav-item">
										<a
											href="/pages/auth/register.html"
											class="nav-link"
											>Register</a
										>
									</li>
								</ul>
							</div>
						</li>
						<li class="nav-item nav-category">Docs</li>
						<li class="nav-item">
							<a
								href="/pages/settings.html"
								class="nav-link">
								<i
									class="link-icon"
									data-feather="settings"></i>
								<span class="link-title">Settings</span>
							</a>
						</li>
					</ul>
				</div>
			</nav>

			<!-- partial -->

			<div class="page-wrapper">
				<!-- partial:partials/_navbar.html -->
				<nav class="navbar">
					<div class="navbar-content">
						<div class="navbar-page-title d-flex align-items-center">
							<h2
								class="mb-0 fw-bold"
								id="navbar-page-title"></h2>
						</div>

						<ul class="navbar-nav">
							<li class="theme-switcher-wrapper nav-item">
								<input
									type="checkbox"
									value=""
									id="theme-switcher"
									title="Toggle theme" />
								<label
									for="theme-switcher"
									aria-label="Toggle theme">
									<div class="box">
										<div class="ball"></div>
										<div class="icons">
											<i class="feather icon-sun"></i>
											<i class="feather icon-moon"></i>
										</div>
									</div>
								</label>
							</li>
							<li class="nav-item dropdown">
								<a
									class="nav-link dropdown-toggle"
									href="#"
									id="appsDropdown"
									role="button"
									data-bs-toggle="dropdown"
									aria-haspopup="true"
									aria-expanded="false"
									title="Apps">
									<i data-feather="grid"></i>
								</a>
								<div
									class="dropdown-menu p-0"
									aria-labelledby="appsDropdown">
									<div class="px-3 py-2 d-flex align-items-center justify-content-between border-bottom">
										<p class="mb-0 fw-bold">Web Apps</p>
										<a
											href="javascript:;"
											class="text-secondary"
											>Edit</a
										>
									</div>
									<div class="row g-0 p-1">
										<div class="col-3 text-center">
											<a
												href="/pages/apps/chat.html"
												class="dropdown-item d-flex flex-column align-items-center justify-content-center w-70px h-70px"
												><i
													data-feather="message-square"
													class="icon-lg mb-1"></i>
												<p class="fs-12px">Chat</p>
											</a>
										</div>
										<div class="col-3 text-center">
											<a
												href="/pages/apps/calendar.html"
												class="dropdown-item d-flex flex-column align-items-center justify-content-center w-70px h-70px"
												><i
													data-feather="calendar"
													class="icon-lg mb-1"></i>
												<p class="fs-12px">Calendar</p>
											</a>
										</div>
										<div class="col-3 text-center">
											<a
												href="/pages/email/inbox.html"
												class="dropdown-item d-flex flex-column align-items-center justify-content-center w-70px h-70px"
												><i
													data-feather="mail"
													class="icon-lg mb-1"></i>
												<p class="fs-12px">Email</p>
											</a>
										</div>
										<div class="col-3 text-center">
											<a
												href="/pages/profile.html"
												class="dropdown-item d-flex flex-column align-items-center justify-content-center w-70px h-70px"
												><i
													data-feather="instagram"
													class="icon-lg mb-1"></i>
												<p class="fs-12px">Profile</p>
											</a>
										</div>
									</div>
									<div class="px-3 py-2 d-flex align-items-center justify-content-center border-top">
										<a href="javascript:;">View all</a>
									</div>
								</div>
							</li>
							<li class="nav-item dropdown">
								<a
									class="nav-link dropdown-toggle"
									href="#"
									id="messageDropdown"
									role="button"
									data-bs-toggle="dropdown"
									aria-haspopup="true"
									aria-expanded="false"
									title="Messages">
									<i data-feather="message-square"></i>
								</a>
								<div
									class="dropdown-menu p-0"
									aria-labelledby="messageDropdown">
									<div class="px-3 py-2 d-flex align-items-center justify-content-between border-bottom">
										<p>9 New Messages</p>
										<a
											href="javascript:;"
											class="text-secondary"
											>Clear all</a
										>
									</div>
									<div class="p-1">
										<a
											href="javascript:;"
											class="dropdown-item d-flex align-items-center py-2">
											<div class="me-3">
												<img
													class="w-30px h-30px rounded-circle"
													src="/assets/images/profile_images/user_stock.png"
													alt="user" />
											</div>
											<div class="d-flex justify-content-between flex-grow-1">
												<div class="me-4">
													<p>Leonardo Payne</p>
													<p class="fs-12px text-secondary">Project status</p>
												</div>
												<p class="fs-12px text-secondary">2 min ago</p>
											</div>
										</a>
										<a
											href="javascript:;"
											class="dropdown-item d-flex align-items-center py-2">
											<div class="me-3">
												<img
													class="w-30px h-30px rounded-circle"
													src="/assets/images/profile_images/user_stock.png"
													alt="user" />
											</div>
											<div class="d-flex justify-content-between flex-grow-1">
												<div class="me-4">
													<p>Carl Henson</p>
													<p class="fs-12px text-secondary">Client meeting</p>
												</div>
												<p class="fs-12px text-secondary">30 min ago</p>
											</div>
										</a>
										<a
											href="javascript:;"
											class="dropdown-item d-flex align-items-center py-2">
											<div class="me-3">
												<img
													class="w-30px h-30px rounded-circle"
													src="/assets/images/profile_images/user_stock.png"
													alt="user" />
											</div>
											<div class="d-flex justify-content-between flex-grow-1">
												<div class="me-4">
													<p>Jensen Combs</p>
													<p class="fs-12px text-secondary">Project updates</p>
												</div>
												<p class="fs-12px text-secondary">1 hrs ago</p>
											</div>
										</a>
										<a
											href="javascript:;"
											class="dropdown-item d-flex align-items-center py-2">
											<div class="me-3">
												<img
													class="w-30px h-30px rounded-circle"
													src="/assets/images/profile_images/user_stock.png"
													alt="user" />
											</div>
											<div class="d-flex justify-content-between flex-grow-1">
												<div class="me-4">
													<p>Amiah Burton</p>
													<p class="fs-12px text-secondary">Project deatline</p>
												</div>
												<p class="fs-12px text-secondary">2 hrs ago</p>
											</div>
										</a>
										<a
											href="javascript:;"
											class="dropdown-item d-flex align-items-center py-2">
											<div class="me-3">
												<img
													class="w-30px h-30px rounded-circle"
													src="/assets/images/profile_images/user_stock.png"
													alt="user" />
											</div>
											<div class="d-flex justify-content-between flex-grow-1">
												<div class="me-4">
													<p>Yaretzi Mayo</p>
													<p class="fs-12px text-secondary">New record</p>
												</div>
												<p class="fs-12px text-secondary">5 hrs ago</p>
											</div>
										</a>
									</div>
									<div class="px-3 py-2 d-flex align-items-center justify-content-center border-top">
										<a href="javascript:;">View all</a>
									</div>
								</div>
							</li>
							<li class="nav-item dropdown">
								<a
									class="nav-link dropdown-toggle"
									href="#"
									id="notificationDropdown"
									role="button"
									data-bs-toggle="dropdown"
									aria-haspopup="true"
									aria-expanded="false"
									title="Notifications">
									<i data-feather="bell"></i>
									<div class="indicator">
										<div class="circle"></div>
									</div>
								</a>
								<div
									class="dropdown-menu p-0"
									aria-labelledby="notificationDropdown">
									<div class="px-3 py-2 d-flex align-items-center justify-content-between border-bottom">
										<p>6 New Notifications</p>
										<a
											href="javascript:;"
											class="text-secondary"
											>Clear all</a
										>
									</div>
									<div class="p-1">
										<a
											href="javascript:;"
											class="dropdown-item d-flex align-items-center py-2">
											<div class="w-30px h-30px d-flex align-items-center justify-content-center bg-primary rounded-circle me-3">
												<i
													class="icon-sm text-white"
													data-feather="gift"></i>
											</div>
											<div class="flex-grow-1 me-2">
												<p>New Order Recieved</p>
												<p class="fs-12px text-secondary">30 min ago</p>
											</div>
										</a>
										<a
											href="javascript:;"
											class="dropdown-item d-flex align-items-center py-2">
											<div class="w-30px h-30px d-flex align-items-center justify-content-center bg-primary rounded-circle me-3">
												<i
													class="icon-sm text-white"
													data-feather="alert-circle"></i>
											</div>
											<div class="flex-grow-1 me-2">
												<p>Server Limit Reached!</p>
												<p class="fs-12px text-secondary">1 hrs ago</p>
											</div>
										</a>
										<a
											href="javascript:;"
											class="dropdown-item d-flex align-items-center py-2">
											<div class="w-30px h-30px d-flex align-items-center justify-content-center bg-primary rounded-circle me-3">
												<img
													class="w-30px h-30px rounded-circle"
													src="/assets/images/profile_images/user_stock.png"
													alt="userr" />
											</div>
											<div class="flex-grow-1 me-2">
												<p>New customer registered</p>
												<p class="fs-12px text-secondary">2 sec ago</p>
											</div>
										</a>
										<a
											href="javascript:;"
											class="dropdown-item d-flex align-items-center py-2">
											<div class="w-30px h-30px d-flex align-items-center justify-content-center bg-primary rounded-circle me-3">
												<i
													class="icon-sm text-white"
													data-feather="layers"></i>
											</div>
											<div class="flex-grow-1 me-2">
												<p>Apps are ready for update</p>
												<p class="fs-12px text-secondary">5 hrs ago</p>
											</div>
										</a>
										<a
											href="javascript:;"
											class="dropdown-item d-flex align-items-center py-2">
											<div class="w-30px h-30px d-flex align-items-center justify-content-center bg-primary rounded-circle me-3">
												<i
													class="icon-sm text-white"
													data-feather="download"></i>
											</div>
											<div class="flex-grow-1 me-2">
												<p>Download completed</p>
												<p class="fs-12px text-secondary">6 hrs ago</p>
											</div>
										</a>
									</div>
									<div class="px-3 py-2 d-flex align-items-center justify-content-center border-top">
										<a href="javascript:;">View all</a>
									</div>
								</div>
							</li>
							<li class="nav-item dropdown">
								<a
									class="nav-link dropdown-toggle"
									href="#"
									id="profileDropdown"
									role="button"
									data-bs-toggle="dropdown"
									aria-haspopup="true"
									aria-expanded="false">
									<img
										class="w-30px h-30px ms-1 rounded-circle"
										src="/assets/images/profile_images/user_stock.png"
										alt="profile" />
								</a>
								<div
									class="dropdown-menu p-0"
									aria-labelledby="profileDropdown">
									<div class="d-flex flex-column align-items-center border-bottom px-5 py-3">
										<div class="mb-3">
											<img
												class="w-80px h-80px rounded-circle"
												src="/assets/images/profile_images/user_stock.png"
												alt="" />
										</div>
										<div class="text-center">
											<p
												class="fs-16px fw-bolder"
												id="navbar-user-name">
												Loading...
											</p>
											<p
												class="fs-12px text-secondary"
												id="navbar-user-email">
												Loading...
											</p>
										</div>
									</div>
									<ul class="list-unstyled p-1">
										<li class="dropdown-item py-2">
											<a
												href="/pages/profile.html"
												class="text-body ms-0">
												<i
													class="me-2 icon-md"
													data-feather="user"></i>
												<span>Profile</span>
											</a>
										</li>
										<li class="dropdown-item py-2">
											<a
												href="javascript:;"
												class="text-body ms-0">
												<i
													class="me-2 icon-md"
													data-feather="edit"></i>
												<span>Edit Profile</span>
											</a>
										</li>
										<li class="dropdown-item py-2">
											<a
												href="javascript:;"
												class="text-body ms-0"
												onclick="logout()">
												<i
													class="me-2 icon-md"
													data-feather="log-out"></i>
												<span>Log Out</span>
											</a>
										</li>
									</ul>
								</div>
							</li>
						</ul>

						<a
							href="#"
							class="sidebar-toggler"
							title="Toggle Sidebar">
							<i data-feather="menu"></i>
						</a>
					</div>
					<script>
						document.addEventListener("DOMContentLoaded", async () => {
							const user = JSON.parse(localStorage.getItem("user"));
							if (!user) {
								window.location.href = "/pages/login.html";
								return;
							}

							try {
								const res = await fetch(`http://localhost:5001/profile/${user.userId}`);
								const data = await res.json();

								document.getElementById("navbar-user-name").textContent = `${data.firstName} ${data.lastName}`;
								document.getElementById("navbar-user-email").textContent = data.email ?? "-";
							} catch (err) {
								console.error("Failed to load profile data:", err);
							}
						});
					</script>

					<script>
						function logout() {
							localStorage.removeItem("user");
							window.location.href = "/pages/login.html";
						}
					</script>
					<script>
						// Set the page title in the navbar
						// Removes "SPARK - " from the title
						document.addEventListener("DOMContentLoaded", function () {
							let pageTitle = document.title || "Page";
							pageTitle = pageTitle.replace(/^\s*SPARK\s*-\s*/i, "");
							// this can override the title if you want it custom
							// let customTitle = document.body.getAttribute("data-page-title");
							document.getElementById("navbar-page-title").textContent = pageTitle;
						});
					</script>
				</nav>

				<!-- partial -->

				<div
					class="page-content container-fluid"
					id="mainContent">

					<!-- Filters toolbar (shared by both tabs) -->
					<div class="card mb-3">
						<div class="card-body">
							<div class="row g-2 align-items-center">
								<div class="col-6 col-md-2">
									<select
										class="form-select"
										id="roleFilter">
										<option value="">All Roles</option>
									</select>
								</div>
								<div class="col-6 col-md-2">
									<select
										class="form-select"
										id="statusFilter">
										<option value="">All Statuses</option>
										<option>Active</option>
										<option>Inactive</option>
									</select>
								</div>
								<div class="col-6 col-md-2">
									<select
										class="form-select"
										id="teamLevelFilter">
										<option value="">All Teams</option>
									</select>
								</div>
								<div class="col-12 col-md-3">
									<input
										type="text"
										class="form-control"
										id="searchBar"
										placeholder="Search by name or ID" />
								</div>
								<div class="col-6 col-md-auto">
									<button
										class="btn btn-outline-secondary w-100"
										id="clearFiltersBtn">
										Clear
									</button>
								</div>
							</div>
						</div>
					</div>

					<!-- Team Members Tab Content-->
					<div
						class="tab-content"
						id="team-members-tab-content">
						<div
							class="tab-pane fade show active"
							id="team-members"
							role="tabpanel"
							aria-labelledby="team-members-tab">
							<div
								id="teamMembersList"
								class="row g-3"></div>
						</div>
					</div>
					<!-- End Team Members Tab Content-->

					<!-- My Recruits Tab Content -->
					<div
						class="tab-content"
						id="recruits-tab-content">
						<div
							class="tab-pane fade"
							id="my-recruits"
							role="tabpanel"
							aria-labelledby="recruits-tab">
							<div
								id="recruitsList"
								class="row g-3"></div>
						</div>
					</div>
					<!-- End My Recruits Tab Content-->

					<!-- Organization Chart Tab Content -->
					<div
						class="tab-content"
						id="org-chart-tab-content">
						<div
							class="tab-pane fade"
							id="org-chart"
							role="tabpanel"
							aria-labelledby="org-chart-tab">
							<div class="card p-4 mb-5">
								<div class="card p-4 mb-5">
									<h1 class="mb-4">Leadership & Recruiting Org Chart</h1>
									<div class="d-flex align-items-center gap-2 mb-3">
										<div
											class="btn-group btn-group-sm"
											role="group"
											aria-label="Org scope">
											<input
												type="radio"
												class="btn-check"
												name="orgScope"
												id="scopeAll"
												checked />
											<label
												class="btn btn-outline-primary"
												for="scopeAll"
												>Entire organization</label
											>
											<input
												type="radio"
												class="btn-check"
												name="orgScope"
												id="scopeMine" />
											<label
												class="btn btn-outline-primary"
												for="scopeMine"
												>My team & recruits</label
											>
										</div>
										<button
											class="btn btn-sm btn-outline-secondary"
											id="fitChartBtn">
											Fit
										</button>
									</div>
									<div id="chart-viewport">
										<div id="chart-stage"></div>
									</div>

									<script src="/attps://code.jquery.com/jquery-3.6.0.min.js"></script>
									<script src="/attps://cdn.jsdelivr.net/npm/orgchart@3.7.0/dist/js/jquery.orgchart.min.js"></script>
									<script>
										(function () {
											const BASE_API = "http://localhost:5001";
											const user = JSON.parse(localStorage.getItem("user")) || {};

											const els = {
												scopeAll: document.getElementById("scopeAll"),
												scopeMine: document.getElementById("scopeMine"),
												fitBtn: document.getElementById("fitChartBtn"),
												viewport: document.getElementById("chart-viewport"),
												stage: document.getElementById("chart-stage"),
											};

											// =========================
											// Pan / Zoom on the stage
											// =========================
											let scale = 1,
												tx = 0,
												ty = 0;
											const MIN_SCALE = 0.25,
												MAX_SCALE = 2.5;
											let pointers = new Map(),
												isPanning = false,
												panStart = { x: 0, y: 0 },
												panFrom = { x: 0, y: 0 },
												lastDist = null;

											function renderTransform() {
												els.stage.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
												els.stage.style.transformOrigin = "0 0";
											}
											function clamp(v, min, max) {
												return Math.max(min, Math.min(max, v));
											}
											function fitToViewport(pad = 24) {
												const prev = els.stage.style.transform;
												els.stage.style.transform = "none";
												const c = els.stage.getBoundingClientRect(),
													v = els.viewport.getBoundingClientRect();
												const s = clamp(Math.min((v.width - pad * 2) / Math.max(1, c.width), (v.height - pad * 2) / Math.max(1, c.height)), MIN_SCALE, MAX_SCALE);
												scale = s;
												tx = Math.round((v.width - c.width * s) / 2);
												ty = Math.round((v.height - c.height * s) / 2);
												els.stage.style.transform = prev;
												renderTransform();
											}

											els.viewport.addEventListener("pointerdown", (e) => {
												els.viewport.setPointerCapture(e.pointerId);
												pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });
												if (pointers.size === 1) {
													isPanning = true;
													panStart = { x: e.clientX, y: e.clientY };
													panFrom = { x: tx, y: ty };
													lastDist = null;
												} else if (pointers.size === 2) {
													const [a, b] = [...pointers.values()];
													lastDist = Math.hypot(a.x - b.x, a.y - b.y);
												}
											});
											els.viewport.addEventListener("pointermove", (e) => {
												if (!pointers.has(e.pointerId)) return;
												pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });
												if (pointers.size === 1 && isPanning) {
													tx = panFrom.x + (e.clientX - panStart.x);
													ty = panFrom.y + (e.clientY - panStart.y);
													renderTransform();
												} else if (pointers.size === 2) {
													const [a, b] = [...pointers.values()];
													const dist = Math.hypot(a.x - b.x, a.y - b.y);
													if (lastDist) {
														const newScale = clamp(scale * (dist / lastDist), MIN_SCALE, MAX_SCALE);
														const midX = (a.x + b.x) / 2,
															midY = (a.y + b.y) / 2;
														const wx = (midX - tx) / scale,
															wy = (midY - ty) / scale;
														tx = midX - wx * newScale;
														ty = midY - wy * newScale;
														scale = newScale;
														renderTransform();
													}
													lastDist = dist;
												}
											});
											["pointerup", "pointercancel", "pointerleave"].forEach((evt) => {
												els.viewport.addEventListener(evt, (e) => {
													els.viewport.releasePointerCapture?.(e.pointerId);
													pointers.delete(e.pointerId);
													if (pointers.size === 0) isPanning = false;
													if (pointers.size < 2) lastDist = null;
												});
											});
											els.viewport.addEventListener(
												"wheel",
												(e) => {
													if (!e.ctrlKey && Math.abs(e.deltaY) < 50) return;
													e.preventDefault();
													const factor = Math.exp(-e.deltaY / 800);
													const newScale = clamp(scale * factor, MIN_SCALE, MAX_SCALE);
													const mx = e.clientX,
														my = e.clientY,
														wx = (mx - tx) / scale,
														wy = (my - ty) / scale;
													tx = mx - wx * newScale;
													ty = my - wy * newScale;
													scale = newScale;
													renderTransform();
												},
												{ passive: false }
											);

											// =========================
											// Data loading
											// =========================
											async function fetchJson(url) {
												const r = await fetch(url);
												if (!r.ok) {
													const err = new Error(`${r.status} ${r.statusText}`);
													err.status = r.status;
													throw err;
												}
												return r.json();
											}

											// Entire org (flat): { userId, firstName, lastName, position, phone, managerUserId }
											async function loadEntireOrgFlat() {
												const url = `${BASE_API}/org/users/${encodeURIComponent(user.userId)}`;
												return fetchJson(url);
											}

											async function loadMyFlat() {
												if (!user?.userId) return [];

												const [team, recruits] = await Promise.all([fetchJson(`${BASE_API}/managedUsers/${user.userId}`).catch(() => []), fetchJson(`${BASE_API}/referrals/${user.userId}`).catch(() => [])]);

												const mapOne = (m) => ({
													userId: m.userId ?? m.UserId ?? m.user?.userId ?? m.User?.UserId ?? null,
													firstName: m.firstName ?? m.FirstName ?? m.user?.firstName ?? m.User?.FirstName ?? "",
													lastName: m.lastName ?? m.LastName ?? m.user?.lastName ?? m.User?.LastName ?? "",
													position: m.role ?? m.Role ?? m.title ?? m.Title ?? "",
													phone: m.phone ?? m.Phone ?? m.user?.phone ?? m.User?.Phone ?? "",
													// keep the REAL manager
													managerUserId: m.managerUserId ?? m.ManagerUserId ?? m.managerId ?? m.ManagerId ?? m.manager_id ?? m.Manager?.UserId ?? null,
												});

												const flat = [...(team || []).map(mapOne), ...(recruits || []).map(mapOne)].filter((p) => p.userId != null);

												return dedupeById(flat);
											}

											// =========================
											// Build forest by manager
											// =========================
											function buildForestByManager(list) {
												const byId = new Map();
												const hasParent = new Set();

												(list || []).forEach((p) => {
													const id = normalizeId(p);
													if (!id || byId.has(id)) return;
													byId.set(id, mapPersonToNode(p));
												});
												byId.forEach((n) => {
													if (!Array.isArray(n.children)) n.children = [];
												});

												(list || []).forEach((p) => {
													const id = normalizeId(p);
													const mgr = getManagerId(p);
													if (!id || !mgr || id === mgr) return;
													if (byId.has(mgr) && byId.has(id)) {
														byId.get(mgr).children.push(byId.get(id));
														hasParent.add(id);
													}
												});

												const roots = [];
												byId.forEach((node, id) => {
													if (!hasParent.has(id)) roots.push(node);
												});
												return roots;
											}

											function mapPersonToNode(p) {
												const fn = p.firstName ?? p.FirstName ?? "";
												const ln = p.lastName ?? p.LastName ?? "";
												const name = [fn, ln].filter(Boolean).join(" ") || p.name || "(no name)";
												const title = p.position ?? p.Position ?? p.role ?? p.title ?? "";

												return {
													name,
													title,
													className: title.toString().toLowerCase().includes("manager") ? "manager" : "",
													sparkId: normalizeId(p),
													id: normalizeId(p),
													phone: p.phone ?? p.Phone ?? "",
													// other fields omitted by design for this view
													children: [],
												};
											}
											function normalizeId(p) {
												const id = p?.userId ?? p?.UserId ?? p?.sparkId ?? p?.id;
												return id == null || String(id).trim() === "" ? null : String(id).trim();
											}
											function getManagerId(p) {
												const v = p?.managerUserId ?? p?.ManagerUserId ?? p?.managerId ?? p?.manager_id;
												return v == null || String(v).trim() === "" ? null : String(v).trim();
											}
											function dedupeById(arr) {
												const seen = new Set(),
													out = [];
												(arr || []).forEach((p) => {
													const id = p?.userId ?? p?.UserId ?? p?.id ?? p?.Id;
													if (!id || seen.has(String(id))) return;
													seen.add(String(id));
													out.push(p);
												});
												return out;
											}

											// =========================
											// Render into #chart-stage
											// =========================
											function renderStage(roots) {
												els.stage.innerHTML = "";
												(roots || []).forEach((root) => {
													const $wrap = $('<div class="orgchart-wrapper"></div>');
													$("#chart-stage").append($wrap);
													$wrap.orgchart({
														data: root,
														nodeContent: "title",
														verticalDepth: 999,
														pan: false,
														zoom: false,
														createNode: function ($node, data) {
															$node.addClass("user-tile");
															if (data.className) $node.addClass(data.className);
															$node.on("click", function (ev) {
																ev.stopPropagation();
																const nameParts = (data.name || "").split(" ");
																const person = {
																	firstName: nameParts[0] || data.name || "",
																	lastName: nameParts.slice(1).join(" "),
																	title: data.title || "",
																	userId: data.sparkId || data.id || "",
																	phone: data.phone || "",
																	email: "",
																};
																if (typeof window.openDrawerWith === "function") window.openDrawerWith(person);
															});
														},
													});
												});
												fitToViewport();
											}

											// =========================
											// Scope + init
											// =========================
											let ENTIRE_FOREST = [];
											let MY_FOREST = [];

											async function init() {
												// Load "My team & recruits"
												const myFlat = await loadMyFlat();
												// Wrap "my view" under me as a single root:
												const meNode = {
													name: [user.firstName, user.lastName].filter(Boolean).join(" ") || "Me",
													title: user.title || user.role || "Manager",
													sparkId: String(user.userId || ""),
													children: buildForestByManager(myFlat), // children can appear if some have managerUserId set to others
												};
												MY_FOREST = [meNode];

												// Try to load entire org; if forbidden, hide the toggle
												try {
													const entireFlat = await loadEntireOrgFlat();
													ENTIRE_FOREST = buildForestByManager(entireFlat);
												} catch (err) {
													if (err?.status === 403) {
														els.scopeAll.disabled = true;
														const lbl = document.querySelector('label[for="scopeAll"]');
														if (lbl) lbl.classList.add("d-none");
													} else {
														console.warn("Failed to load entire org:", err);
													}
												}

												// Wire controls
												els.fitBtn?.addEventListener("click", () => fitToViewport());
												els.scopeAll?.addEventListener("change", () => {
													if (els.scopeAll.checked) renderStage(ENTIRE_FOREST);
												});
												els.scopeMine?.addEventListener("change", () => {
													if (els.scopeMine.checked) renderStage(MY_FOREST);
												});

												// Initial paint
												if (!els.scopeAll.disabled && ENTIRE_FOREST.length) {
													els.scopeAll.checked = true;
													renderStage(ENTIRE_FOREST);
												} else {
													els.scopeMine.checked = true;
													renderStage(MY_FOREST);
												}
											}

											document.addEventListener("DOMContentLoaded", init);
										})();
									</script>
								</div>
							</div>
						</div>
						<!-- End Organization Chart Tab Content -->

						<!-- Recruiting Tab Content -->
						<div
							class="tab-content"
							id="recruit-tab-content">
							<div
								class="tab-pane fade"
								id="recruit"
								role="tabpanel"
								aria-labelledby="recruit-tab">
								<div class="mt-3 card">
									<div class="card-body">
										<h5>Referral Tools</h5>
										<p><strong>Your Referral Link:</strong> https://sparkpro.io/signup?ref=JORDAN12</p>
										<button class="btn btn-outline-primary btn-sm">Copy Link</button>
										<div
											id="qrCodeContainer"
											class="my-3">
											[QR Code Here]
										</div>
										<button class="btn btn-sm btn-outline-secondary">Download QR</button>
										<hr />
										<h5>Recruiting Performance Tracker</h5>
										<ul>
											<li>New Recruits This Month: 3</li>
											<li>Total Recruits YTD: 12</li>
											<li>Override Earnings from Recruits: $4,200</li>
											<li>Most Recent Recruit: David Allen (2025-07-23)</li>
											<li>
												<a
													href="#orgChartTab"
													data-bs-toggle="tab"
													>View Downline →</a
												>
											</li>
										</ul>
										<hr />
										<h5>Recruiting Resources</h5>
										<ul>
											<li><a href="#">"Why Join SPARK" PDF</a></li>
											<li><a href="#">Onboarding Video</a></li>
											<li><a href="#">Social Media Templates</a></li>
											<li><code>"Hey! I use this software called SPARK... want to check it out?"</code></li>
										</ul>
									</div>
								</div>
							</div>
						</div>
						<!-- End Recruiting Tab Content -->

						<!-- Side Panel Logic-->
						<div
							class="offcanvas offcanvas-end"
							tabindex="-1"
							id="memberDrawer"
							aria-labelledby="memberDrawerLabel">
							<div class="offcanvas-header">
								<h5
									class="offcanvas-title"
									id="memberDrawerLabel">
									Member
								</h5>
								<button
									type="button"
									class="btn-close text-reset"
									data-bs-dismiss="offcanvas"
									aria-label="Close"></button>
							</div>
							<div
								class="offcanvas-body"
								id="memberDrawerBody">
								<!-- filled by JS -->
							</div>
						</div>
					</div>
				</div>

				<!-- partial:partials/_footer.html -->
				<footer class="footer d-flex flex-row align-items-center justify-content-between px-4 py-3 border-top small">
					<p class="text-secondary mb-1 mb-md-0">
						Copyright © <span id="currentYear"></span>
						<a
							href="https://sparkpro.io"
							target="_blank"
							rel="noopener noreferrer"
							>Spark</a
						>.
					</p>
					<script>
						document.getElementById("currentYear").textContent = new Date().getFullYear();
					</script>
					<p class="text-secondary">
						Handcrafted By<i
							class="mb-1 text-primary ms-1 icon-sm"
							data-feather="zap"></i>
					</p>
				</footer>

				<!-- partial -->
			</div>
		</div>

		<!-- core:js -->
		<script src="/assets/vendors/core/core.js"></script>
		<!-- endinject -->

		<!-- Plugin js for this page -->
		<!-- End plugin js for this page -->

		<!-- inject:js -->
		<script src="/assets/vendors/feather-icons/feather.min.js"></script>
		<script src="/assets/js/app.js"></script>
		<!-- endinject -->

		<!-- Custom js for this page -->

		<script>
			(function () {
				const BASE_API = "http://localhost:5001";
				const user = JSON.parse(localStorage.getItem("user"));
				if (!user) {
					window.location.href = "/pages/login.html";
					return;
				}

				const els = {
					teamList: document.getElementById("teamMembersList"),
					recruitsList: document.getElementById("recruitsList"),
					drawer: document.getElementById("memberDrawer"),
					drawerTitle: document.getElementById("memberDrawerLabel"),
					drawerBody: document.getElementById("memberDrawerBody"),
					// filters
					roleFilter: document.getElementById("roleFilter"),
					statusFilter: document.getElementById("statusFilter"),
					teamLevelFilter: document.getElementById("teamLevelFilter"),
					searchBar: document.getElementById("searchBar"),
				};

				let cache = {
					team: [],
					recruits: [],
				};

				document.addEventListener("DOMContentLoaded", init);

				async function init() {
					try {
						const [team, recruits] = await Promise.all([fetchJson(`${BASE_API}/managedUsers/${user.userId}`), fetchJson(`${BASE_API}/referrals/${user.userId}`)]);

						cache.team = team || [];
						cache.recruits = recruits || [];

						renderPeople(cache.team, els.teamList);
						renderPeople(cache.recruits, els.recruitsList);

						wireFilters();
						wireTabRoleSync();

						// Build role list for the initially active tab (Team Members is active by default)
						refreshRoleOptionsFrom(getActiveDataset());
						refreshTeamOptionsFrom(getActiveDataset());
					} catch (err) {
						console.error("Failed to load lists", err);
						toast("Could not load team data.", "danger");
					}
				}

				function wireFilters() {
					const apply = debounce(applyFilters, 150);
					els.roleFilter?.addEventListener("change", apply);
					els.statusFilter?.addEventListener("change", apply);
					els.teamLevelFilter?.addEventListener("change", apply);
					els.searchBar?.addEventListener("input", apply);

					// Optional clear button if you added it
					document.getElementById("clearFiltersBtn")?.addEventListener("click", () => {
						els.roleFilter.value = "";
						els.statusFilter.value = "";
						els.teamLevelFilter.value = "";
						els.searchBar.value = "";
						applyFilters();
					});
				}

				// When switching tabs, rebuild the Role options from that tab's data
				function wireTabRoleSync() {
					document.querySelectorAll('#profileTab [data-bs-toggle="tab"]').forEach((btn) => {
						btn.addEventListener("shown.bs.tab", () => {
							const list = getActiveDataset();
							refreshRoleOptionsFrom(list);
							refreshTeamOptionsFrom(list);
							applyFilters();
						});
					});
				}

				function getActiveDataset() {
					const activePane = document.querySelector(".tab-pane.show.active");
					return activePane?.id === "my-recruits" ? cache.recruits : cache.team;
				}

				function refreshRoleOptionsFrom(list) {
					if (!els.roleFilter) return;

					const prevValue = (els.roleFilter.value || "").toLowerCase();

					// Collect unique roles from this tab's raw data (unfiltered)
					const roles = Array.from(new Set((list || []).map((p) => (p.role ?? p.title ?? "").toString().trim()).filter(Boolean)));

					// Sort using locale compare
					roles.sort((a, b) => a.localeCompare(b));

					// Rebuild options
					const opts = ['<option value="">All Roles</option>'].concat(roles.map((r) => `<option value="${escapeHtml(r)}">${escapeHtml(r)}</option>`));

					els.roleFilter.innerHTML = opts.join("");

					// Try to keep previous selection if it still exists
					const match = roles.find((r) => r.toLowerCase() === prevValue);
					els.roleFilter.value = match || "";

					// If we changed the available options, it may alter filtering—so re-apply
					applyFilters();
				}

				function refreshTeamOptionsFrom(list) {
					const sel = els.teamLevelFilter;
					if (!sel) return;

					const prev = sel.value;

					const teams = Array.from(new Set((list || []).map((p) => (p.team ?? p.teamLevel ?? p.teamName ?? "").toString().trim()).filter(Boolean))).sort((a, b) => a.localeCompare(b));

					sel.innerHTML = ['<option value="">All Teams</option>'].concat(teams.map((t) => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`)).join("");

					// keep previous choice if it still exists
					if (teams.includes(prev)) sel.value = prev;
					else sel.value = "";
				}

				function applyFilters() {
					const filters = getFilters();
					renderPeople(filterList(cache.team, filters), els.teamList);
					renderPeople(filterList(cache.recruits, filters), els.recruitsList);
				}

				function getFilters() {
					return {
						role: (els.roleFilter?.value || "").trim().toLowerCase(),
						status: (els.statusFilter?.value || "").trim().toLowerCase(),
						team: (els.teamLevelFilter?.value || "").trim().toLowerCase(),
						q: (els.searchBar?.value || "").trim().toLowerCase(),
					};
				}

				function filterList(list, f) {
					if (!list || list.length === 0) return [];
					return list.filter((p) => {
						const role = (p.role ?? p.title ?? "").toString().toLowerCase();
						const team = (p.team ?? p.teamLevel ?? p.teamName ?? "").toString().toLowerCase();
						const active = getActiveFlag(p);

						if (f.role && role !== f.role) return false;
						if (f.team && team !== f.team) return false;
						if (f.status) {
							if (f.status === "active" && !active) return false;
							if (f.status === "inactive" && active) return false;
						}
						if (f.q) {
							const fullName = `${p.firstName ?? ""} ${p.lastName ?? ""}`.toLowerCase();
							const idStr = (p.userId ?? p.sparkId ?? "").toString().toLowerCase();
							if (!fullName.includes(f.q) && !idStr.includes(f.q)) return false;
						}
						return true;
					});
				}

				async function fetchJson(url, options = {}) {
					const res = await fetch(url, options);
					if (!res.ok) {
						const t = await res.text();
						throw new Error(`${res.status} ${res.statusText} - ${t}`);
					}
					return res.json();
				}

				// Render a grid of cards
				function renderPeople(list, container) {
					container.innerHTML = "";
					if (!list || list.length === 0) {
						container.innerHTML = `<div class="text-secondary">No records found.</div>`;
						return;
					}

					list.forEach((p) => {
						const col = document.createElement("div");
						col.className = "col-12 col-md-6 col-xl-4";

						const active = getActiveFlag(p);
						const role = escapeHtml(p.role ?? p.title ?? "-");
						const office = escapeHtml(p.office ?? "-");
						const region = p.region ? " • " + escapeHtml(p.region) : "";
						const name = `${escapeHtml(p.firstName)} ${escapeHtml(p.lastName)}`;

						col.innerHTML = `
							<div class="card h-100">
								<div class="card-body d-flex">
								<img src="/assets/images/profile_images/user_stock.png" class="rounded-circle me-3" width="48" height="48" alt="">
								<div class="flex-grow-1">
									<div class="d-flex align-items-center justify-content-between">
									<h6 class="mb-0">${name}</h6>
									<span class="badge ${active ? "bg-success" : "bg-secondary"}">${active ? "Active" : "Inactive"}</span>
									</div>
									<div class="text-secondary small">${role}</div>
									<div class="text-secondary small">${office}${region}</div>
									<div class="mt-2 d-flex gap-2">
									<button class="btn btn-sm btn-outline-primary" data-action="view" data-user-id="${p.userId}">View</button>
									</div>
								</div>
								</div>
								${renderMiniSales(p.UncalledSolarSales)}
							</div>
							`;

						col.querySelector('[data-action="view"]').addEventListener("click", () => openDrawerWith(p));
						container.appendChild(col);
					});
				}

				function renderMiniSales(sales) {
					if (!sales || sales.length === 0) return "";
					const rows = sales
						.map(
							(s) => `
						<tr>
						<td>#${s.saleId}</td>
						<td>${escapeHtml(s.customerName || "-")}</td>
						<td class="text-nowrap">${formatCurrency(s.systemValue)}</td>
						<td class="text-nowrap">${formatDate(s.createdAt)}</td>
						</tr>`
						)
						.join("");

					return `
						<div class="table-responsive border-top">
						<table class="table table-sm mb-0">
							<thead>
							<tr>
								<th colspan="4" class="border-0">Recent Solar Activity</th>
							</tr>
							<tr>
								<th class="text-secondary fw-normal">Sale</th>
								<th class="text-secondary fw-normal">Customer</th>
								<th class="text-secondary fw-normal">Value</th>
								<th class="text-secondary fw-normal">Date</th>
							</tr>
							</thead>
							<tbody>${rows}</tbody>
						</table>
						</div>
					`;
				}

				// SIDE PANEL
				function openDrawerWith(person) {
					els.drawerTitle.textContent = `${person.firstName} ${person.lastName}`;

					const rows = (person.UncalledSolarSales || [])
						.map(
							(s) => `
						<tr>
						<td>#${s.saleId}</td>
						<td>${escapeHtml(s.customerName || "-")}</td>
						<td class="text-nowrap">${formatCurrency(s.systemValue)}</td>
						<td class="text-nowrap">${formatDate(s.createdAt)}</td>
						</tr>
					`
						)
						.join("");

					const isActive = getActiveFlag(person);
					const team = person.team ?? person.teamLevel ?? person.teamName ?? "N/A";

					els.drawerBody.innerHTML = `
						<div class="d-flex align-items-center mb-3">
						<img src="/assets/images/profile_images/user_stock.png" class="rounded-circle me-3" width="56" height="56" alt="">
						<div class="min-w-0">
							<div class="fw-bold text-truncate">${escapeHtml(person.firstName)} ${escapeHtml(person.lastName)}</div>
							<div class="text-secondary small text-truncate">${escapeHtml(person.role ?? "-")}</div>
						</div>
						</div>

						<!-- Responsive info grid: stacks on xs, two columns on >= sm -->
						<div class="row g-3 mb-3 info-grid">
						<div class="col-12 col-sm-6 card-field">
							<div class="small text-secondary">Email</div>
							<div class="value">
							${person.email ? `<a class="text-break" href="/mailto:${person.email}">${escapeHtml(person.email)}</a>` : "-"}
							</div>
						</div>
						<div class="col-12 col-sm-6 card-field">
							<div class="small text-secondary">Phone</div>
							<div class="value">${formatPhone(person.phone) ?? "-"}</div>
						</div>
						<div class="col-12 col-sm-6 card-field">
							<div class="small text-secondary">Office</div>
							<div class="value text-break">${escapeHtml(person.office ?? "-")}</div>
						</div>
						<div class="col-12 col-sm-6 card-field">
							<div class="small text-secondary">Region</div>
							<div class="value">${escapeHtml(person.region ?? "-")}</div>
						</div>
						<div class="col-12 col-sm-6 card-field">
							<div class="small text-secondary">Team</div>
							<div class="value text-break">${escapeHtml(team)}</div>
						</div>
						<div class="col-12 col-sm-6 card-field">
							<div class="small text-secondary">Status</div>
							<div class="value"><span class="badge ${isActive ? "bg-success" : "bg-secondary"}">${isActive ? "Active" : "Inactive"}</span></div>
						</div>

						<!-- NEW: Override fields -->
						<div class="col-12 col-sm-6 card-field">
							<div class="small text-secondary">Override %</div>
							<div class="value">${formatPercent(person.overridePercent ?? person.override_percentage)}</div>
						</div>
						<div class="col-12 col-sm-6 card-field">
							<div class="small text-secondary">Total Overrides</div>
							<div class="value">${formatCurrency(person.totalOverride ?? person.total_overrides)}</div>
						</div>
						</div>

						<div class="mb-2 fw-bold">Recent Solar Activity</div>
						<div class="table-responsive">
						<table class="table table-sm">
							<thead>
							<tr>
								<th>Sale</th>
								<th>Customer</th>
								<th>Value</th>
								<th>Date</th>
							</tr>
							</thead>
							<tbody>${rows || `<tr><td colspan="4" class="text-secondary">No recent activity</td></tr>`}</tbody>
						</table>
						</div>
					`;

					const offcanvas = bootstrap.Offcanvas.getOrCreateInstance(els.drawer);
					offcanvas.show();
				}

				// Helpers
				function getActiveFlag(p) {
					const v = p?.isActive ?? p?.status ?? p?.Status ?? p?.active ?? p?.Active;
					if (typeof v === "boolean") return v;
					if (typeof v === "number") return v === 1;
					if (typeof v === "string") {
						const s = v.trim().toLowerCase();
						return s === "active" || s === "true" || s === "yes" || s === "1";
					}
					return false;
				}

				function escapeHtml(str) {
					if (str == null) return "";
					return String(str).replace(
						/[&<>"']/g,
						(s) =>
							({
								"&": "&amp;",
								"<": "&lt;",
								">": "&gt;",
								'"': "&quot;",
								"'": "&#039;",
							}[s])
					);
				}
				function formatPhone(phone) {
					if (!phone || phone.length !== 10) return phone ?? "N/A";
					return `(${phone.slice(0, 3)}) ${phone.slice(3, 6)}-${phone.slice(6)}`;
				}
				function formatCurrency(v) {
					if (v == null) return "-";
					try {
						return new Intl.NumberFormat(undefined, { style: "currency", currency: "USD", maximumFractionDigits: 0 }).format(v);
					} catch {
						return `$${v}`;
					}
				}
				function formatDate(d) {
					if (!d) return "-";
					const dt = new Date(d);
					if (isNaN(dt)) return "-";
					return dt.toLocaleDateString();
				}
				function toast(msg, variant = "primary") {
					console.log(`[${variant}] ${msg}`);
				}
				function debounce(fn, wait = 150) {
					let t;
					return (...args) => {
						clearTimeout(t);
						t = setTimeout(() => fn.apply(null, args), wait);
					};
				}
				function formatPercent(v) {
					if (v == null || v === "") return "-";
					const n = Number(String(v).toString().replace("%", "").trim());
					if (Number.isFinite(n)) return `${n}%`;
					return escapeHtml(String(v));
				}
			})();
		</script>
		<!-- End custom js for this page -->
	</body>
</html>
